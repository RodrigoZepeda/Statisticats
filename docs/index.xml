<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Statisticats üê±</title>
<link>https://rodrigozepeda.github.io/Statisticats/index.html</link>
<atom:link href="https://rodrigozepeda.github.io/Statisticats/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.1.251</generator>
<lastBuildDate>Tue, 29 Aug 2023 04:00:00 GMT</lastBuildDate>
<item>
  <title>Bootstrapping a survey regression</title>
  <dc:creator>Rodrigo Zepeda-Tello</dc:creator>
  <link>https://rodrigozepeda.github.io/Statisticats/posts/bootstraping-a-survey-regression/index.html</link>
  <description><![CDATA[ 



<section id="bootstrap-101" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-101">Bootstrap 101</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">pacman<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">p_load</span>(survey, svrep, matrixStats, modelsummary)</span></code></pre></div>
</div>
<p>The main idea behind bootstrap is that resampling the random sample allows us to generate replicates of the sampling process itself. Using these re-sampled data, we can generate our desired estimators. These estimators will be asymptotically equivalent to the desired quantities.</p>
<section id="bootstraping-a-mean" class="level3">
<h3 class="anchored" data-anchor-id="bootstraping-a-mean">Bootstraping a mean</h3>
<p>As an example, consider a random sample of <code>n = 1000</code> samples from a <img src="https://latex.codecogs.com/png.latex?Normal(0,1)"> distribution: <img src="https://latex.codecogs.com/png.latex?%0A%5C%7BX_1,%20X_2,%20%5Cdots,%20X_n%5C%7D%20%5Ctext%7B%20with%20%7D%20X_i%5Csim%20%5Ctext%7BNormal%7D(0,1)%0A"></p>
<p>In <code>R</code> this can be obtained as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">samples <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">1000</span>)</span></code></pre></div>
</div>
<p>One can estimate the mean with the classical estimator, <img src="https://latex.codecogs.com/png.latex?%5Cbar%7BX%7D%20=%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20X_i">:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">mean</span>(samples)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01726104</code></pre>
</div>
</div>
<p>In <code>R</code> this has already been programmed as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">t.test</span>(samples)<span class="sc" style="color: #5E5E5E;">$</span>conf.int</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.04433005  0.07885213
attr(,"conf.level")
[1] 0.95</code></pre>
</div>
</div>
<p>The bootstrap estimate relies on going over several samples and calculating the mean for each of the resamples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">resample_means <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="cn" style="color: #8f5902;">NA</span>, <span class="dv" style="color: #AD0000;">1000</span>) <span class="co" style="color: #5E5E5E;">#Save the mean of the re-samples</span></span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">1000</span>){</span>
<span id="cb7-3">  resample <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">sample</span>(samples, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1000</span>, <span class="at" style="color: #657422;">replace =</span> <span class="cn" style="color: #8f5902;">TRUE</span>)</span>
<span id="cb7-4">  resample_means[i] <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">mean</span>(resample)</span>
<span id="cb7-5">}</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;">#Bootstrap estimate:</span></span>
<span id="cb7-8"><span class="fu" style="color: #4758AB;">mean</span>(resample_means)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01633088</code></pre>
</div>
</div>
<p>The <strong>Wald-type</strong> confidence intervals at level <img src="https://latex.codecogs.com/png.latex?(1-%5Calpha)%5Ctimes%20100%5C%25"> are given by: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbar%7BX%7D%5Cpm%20t_%7B1-%5Calpha/2%7D%5Csqrt%7B%5Cwidehat%7B%5Ctextrm%7BVar%7D%7D_%7B%5Ctext%7BBoot%7D%7D(%5Cbar%7BX%7D)%7D%0A"> where the unbiased estimator of the variance is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Ctextrm%7BVar%7D%7D_%7B%5Ctext%7BBoot%7D%7D(%5Cbar%7BX%7D)%20=%20%5Csum%5Climits_%7Bi%20=%201%7D%5E%7Bn%7D%20(%5Cbar%7BX%7D_%7B%5Ctext%7BBoot%7D,i%7D%20-%20%5Cbar%7BX%7D)%5E2%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cbar%7BX%7D_%7B%5Ctext%7BBoot%7D,i%7D"> is the estimate of the mean in the <img src="https://latex.codecogs.com/png.latex?i">-th bootstrap sample.</p>
<p>In <code>R</code>, these confidence intervals can be computed as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">mu_estim  <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">mean</span>(resample_means)</span>
<span id="cb9-2">var_estim <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">var</span>(resample_means)</span>
<span id="cb9-3">t_1_alpha <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">qt</span>(<span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">0.05</span><span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">df =</span> <span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb9-4">ci_wald   <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"Lower"</span> <span class="ot" style="color: #003B4F;">=</span> mu_estim <span class="sc" style="color: #5E5E5E;">-</span> t_1_alpha<span class="sc" style="color: #5E5E5E;">*</span><span class="fu" style="color: #4758AB;">sqrt</span>(var_estim), </span>
<span id="cb9-5">               <span class="st" style="color: #20794D;">"Upper"</span> <span class="ot" style="color: #003B4F;">=</span> mu_estim <span class="sc" style="color: #5E5E5E;">+</span> t_1_alpha<span class="sc" style="color: #5E5E5E;">*</span><span class="fu" style="color: #4758AB;">sqrt</span>(var_estim))</span></code></pre></div>
</div>
<blockquote class="blockquote">
<p>Notice that the formula is not divided by <img src="https://latex.codecogs.com/png.latex?n"> as we are estimating the standard error of the variance for the <strong>mean</strong> statistic and not of the <img src="https://latex.codecogs.com/png.latex?X_i">. Intuitively, it makes sense <strong>not</strong> to divide by the number of bootstrap samples. If we did we could then artificially decrease uncertainty around estimates just by taking more boostrap samples without gathering more data!</p>
</blockquote>
<p>Another type of confidence intervals (<a href="https://stats.stackexchange.com/a/357498/81181">not recommended</a>) is the <strong>percentile confidence interval</strong> given by the <img src="https://latex.codecogs.com/png.latex?%5Calpha/2"> and <img src="https://latex.codecogs.com/png.latex?1%20-%20%5Calpha/2"> sample-percentiles of the bootstrap sample:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5B%5Cbar%7BX%7D_%7B%5Ctext%7BBoot%7D,%20(%5Calpha/2)%7D,%20%5Cbar%7BX%7D_%7B%5Ctext%7BBoot%7D,%20(1%20-%20%5Calpha/2)%7D%5D%0A"> In <code>R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;">#Bootstrap estimate:</span></span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;">quantile</span>(resample_means, <span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">0.025</span>, <span class="fl" style="color: #AD0000;">0.975</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       2.5%       97.5% 
-0.04485072  0.07992000 </code></pre>
</div>
</div>
<p>In this particular case, they all are excellent estimates for our quantity of interest:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/bootstraping-a-survey-regression/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="generating-bootstrap-samples-for-surveys" class="level2">
<h2 class="anchored" data-anchor-id="generating-bootstrap-samples-for-surveys">Generating bootstrap samples for surveys</h2>
<p>There are already pre-programmed functions in the <code>survey</code> package that allow users to calculate some quantities of interest via bootstrap. In this example, we‚Äôll go through the first part of the <a href="https://cran.r-project.org/web/packages/survey/vignettes/survey.pdf"><code>survey</code> example vignette</a> but with bootstrap. We‚Äôll load the data and setup the survey design, closely following the vignette:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;">library</span>(survey)</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;">data</span>(api)</span>
<span id="cb12-3">clus1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">svydesign</span>(<span class="at" style="color: #657422;">id =</span> <span class="sc" style="color: #5E5E5E;">~</span>dnum, <span class="at" style="color: #657422;">weights =</span> <span class="sc" style="color: #5E5E5E;">~</span>pw, <span class="at" style="color: #657422;">data =</span> apiclus1, <span class="at" style="color: #657422;">fpc =</span> <span class="sc" style="color: #5E5E5E;">~</span>fpc)</span></code></pre></div>
</div>
<p>Then, we‚Äôll estimate the mean:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;">svymean</span>(<span class="sc" style="color: #5E5E5E;">~</span>api00, clus1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        mean     SE
api00 644.17 23.542</code></pre>
</div>
</div>
<p>To change into bootstrap mode one has only to replicate the design</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">boot_clus1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as_bootstrap_design</span>(clus1, <span class="at" style="color: #657422;">replicates =</span> <span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;">svymean</span>(<span class="sc" style="color: #5E5E5E;">~</span>api00, boot_clus1) <span class="co" style="color: #5E5E5E;">#Mean but now using 1000 re-samples</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        mean     SE
api00 644.17 22.599</code></pre>
</div>
</div>
<p>Notice that we had to use the design to generate the replicates. This is an important thing to keep in mind as for complex surveys one cannot simply resample without considering the design <a href="http://dx.doi.org/10.1214/16-SS113"><span class="citation" data-cites="mashreghi2016survey">Mashreghi, Haziza, and L√©ger (</span></a>2016).</p>
</section>
<section id="playing-with-the-bootstrapped-sample" class="level2">
<h2 class="anchored" data-anchor-id="playing-with-the-bootstrapped-sample">Playing with the bootstrapped sample</h2>
<p>Now, what happens if we actually need to obtain the replicates (and use them!). For example, when implementing a model that is not already pre-programmed as part of the survey package. In that case, we‚Äôll need to use <code>weights</code> and apply a weighted version of the model to the different estimates. As an example, consider replicating the following linear regression model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">regmodel <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">svyglm</span>(api00 <span class="sc" style="color: #5E5E5E;">~</span> ell <span class="sc" style="color: #5E5E5E;">+</span> meals, <span class="at" style="color: #657422;">design =</span> clus1)</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;">#Create regression table</span></span>
<span id="cb17-4">regmodel <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb17-5">  <span class="fu" style="color: #4758AB;">modelsummary</span>(<span class="at" style="color: #657422;">estimate =</span> <span class="st" style="color: #20794D;">"{estimate} [{conf.low}, {conf.high}]"</span>, </span>
<span id="cb17-6">               <span class="at" style="color: #657422;">statistic  =</span> <span class="cn" style="color: #8f5902;">NULL</span>, <span class="at" style="color: #657422;">conf_level =</span> <span class="fl" style="color: #AD0000;">0.95</span>,</span>
<span id="cb17-7">               <span class="at" style="color: #657422;">gof_omit =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"IC|R|L|N|F"</span>),</span>
<span id="cb17-8">               <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Classical coefficient estimators"</span>)</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Classical coefficient estimators</caption>
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> &nbsp;(1) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> 817.182 [776.502, 857.863] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ell </td>
   <td style="text-align:center;"> ‚àí0.509 [‚àí1.219, 0.201] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> meals </td>
   <td style="text-align:center;"> ‚àí3.146 [‚àí3.803, ‚àí2.488] </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Of course, one way to do that would be via the survey replicates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">regmodel2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">svyglm</span>(api00 <span class="sc" style="color: #5E5E5E;">~</span> ell <span class="sc" style="color: #5E5E5E;">+</span> meals, <span class="at" style="color: #657422;">design =</span> boot_clus1)</span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;">#Create regression table</span></span>
<span id="cb18-4">regmodel2 <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;">modelsummary</span>(<span class="at" style="color: #657422;">estimate =</span> <span class="st" style="color: #20794D;">"{estimate} [{conf.low}, {conf.high}]"</span>, </span>
<span id="cb18-6">               <span class="at" style="color: #657422;">statistic  =</span> <span class="cn" style="color: #8f5902;">NULL</span>, <span class="at" style="color: #657422;">conf_level =</span> <span class="fl" style="color: #AD0000;">0.95</span>,</span>
<span id="cb18-7">               <span class="at" style="color: #657422;">gof_omit =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"IC|R|L|N|F"</span>),</span>
<span id="cb18-8">               <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Bootstrapped coefficient estimators"</span>)</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Bootstrapped coefficient estimators</caption>
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> &nbsp;(1) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> 817.182 [772.839, 861.526] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ell </td>
   <td style="text-align:center;"> ‚àí0.509 [‚àí1.443, 0.425] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> meals </td>
   <td style="text-align:center;"> ‚àí3.146 [‚àí4.028, ‚àí2.263] </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The <code>svyrep</code> package allows us to obtain a <code>data.frame</code> of replicate <code>weights</code> each of them representing the bootstrapped sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;">#Get the replicate weights</span></span>
<span id="cb19-2">rep_weights <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">weights</span>(boot_clus1)</span></code></pre></div>
</div>
<p>We then loop through each of the estimates and compute the variables of interest. In this case, we‚Äôll compute and save the coefficients of the regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">coefficients <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">matrix</span>(<span class="cn" style="color: #8f5902;">NA</span>, <span class="at" style="color: #657422;">nrow =</span> <span class="fu" style="color: #4758AB;">ncol</span>(rep_weights), <span class="at" style="color: #657422;">ncol =</span> <span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb20-2"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="fu" style="color: #4758AB;">ncol</span>(rep_weights)){</span>
<span id="cb20-3">  model <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(api00 <span class="sc" style="color: #5E5E5E;">~</span> ell <span class="sc" style="color: #5E5E5E;">+</span> meals, <span class="at" style="color: #657422;">data =</span> apiclus1, </span>
<span id="cb20-4">              <span class="at" style="color: #657422;">weights =</span> rep_weights[,i])</span>
<span id="cb20-5">  coefficients[i,] <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">coef</span>(model)</span>
<span id="cb20-6">}</span></code></pre></div>
</div>
<p>Finally we aggregate the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">df <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="st" style="color: #20794D;">"variable"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">names</span>(<span class="fu" style="color: #4758AB;">coef</span>(model)),</span>
<span id="cb21-2">                 <span class="st" style="color: #20794D;">"estimates"</span> <span class="ot" style="color: #003B4F;">=</span>  coefficients <span class="sc" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">colMeans</span>(),</span>
<span id="cb21-3">                 <span class="st" style="color: #20794D;">"sd"</span> <span class="ot" style="color: #003B4F;">=</span> coefficients <span class="sc" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">colSds</span>())</span></code></pre></div>
</div>
</section>
<section id="confidence-intervals" class="level2">
<h2 class="anchored" data-anchor-id="confidence-intervals">Confidence intervals</h2>
<p>Following <span class="citation" data-cites="arnab2017survey">Arnab (2017)</span> we can estimate both types of confidence intervals for a complex survey design:</p>
<section id="wald-type-confidence-intervals" class="level3">
<h3 class="anchored" data-anchor-id="wald-type-confidence-intervals">Wald-type confidence intervals</h3>
<p>Wald-type confidence intervals can be estimated with the variance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;">data.frame</span>(<span class="st" style="color: #20794D;">"variable"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">names</span>(<span class="fu" style="color: #4758AB;">coef</span>(model)),</span>
<span id="cb22-2">           <span class="st" style="color: #20794D;">"estimates"</span> <span class="ot" style="color: #003B4F;">=</span>  <span class="fu" style="color: #4758AB;">colMeans</span>(coefficients),</span>
<span id="cb22-3">           <span class="st" style="color: #20794D;">"var"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">colVars</span>(coefficients),</span>
<span id="cb22-4">           <span class="st" style="color: #20794D;">"ci_low"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">colMeans</span>(coefficients) <span class="sc" style="color: #5E5E5E;">-</span> t_1_alpha<span class="sc" style="color: #5E5E5E;">*</span><span class="fu" style="color: #4758AB;">sqrt</span>(<span class="fu" style="color: #4758AB;">colVars</span>(coefficients)),</span>
<span id="cb22-5">           <span class="st" style="color: #20794D;">"ci_up"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">colMeans</span>(coefficients) <span class="sc" style="color: #5E5E5E;">+</span> t_1_alpha<span class="sc" style="color: #5E5E5E;">*</span><span class="fu" style="color: #4758AB;">sqrt</span>(<span class="fu" style="color: #4758AB;">colVars</span>(coefficients)))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     variable   estimates         var     ci_low       ci_up
1 (Intercept) 814.2897385 414.6276549 774.331790 854.2476873
2         ell  -0.5015806   0.1838348  -1.342952   0.3397912
3       meals  -3.1202612   0.1643234  -3.915731  -2.3247913</code></pre>
</div>
</div>
</section>
<section id="quantile-confidence-intervals" class="level3">
<h3 class="anchored" data-anchor-id="quantile-confidence-intervals">Quantile confidence intervals</h3>
<p>Quantile confidence intervals can be estimated with the variance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;">data.frame</span>(<span class="st" style="color: #20794D;">"variable"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">names</span>(<span class="fu" style="color: #4758AB;">coef</span>(model)),</span>
<span id="cb24-2">           <span class="st" style="color: #20794D;">"lower_quantile_ci"</span>  <span class="ot" style="color: #003B4F;">=</span>  coefficients <span class="sc" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">colQuantiles</span>(<span class="at" style="color: #657422;">probs =</span> <span class="fl" style="color: #AD0000;">0.025</span>),</span>
<span id="cb24-3">           <span class="st" style="color: #20794D;">"upper_quantile_ci"</span>  <span class="ot" style="color: #003B4F;">=</span>  coefficients <span class="sc" style="color: #5E5E5E;">|&gt;</span> <span class="fu" style="color: #4758AB;">colQuantiles</span>(<span class="at" style="color: #657422;">probs =</span> <span class="fl" style="color: #AD0000;">0.975</span>))  </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     variable lower_quantile_ci upper_quantile_ci
1 (Intercept)        772.978734       850.8792929
2         ell         -1.276907         0.4150228
3       meals         -4.000878        -2.3307806</code></pre>
</div>
</div>
<p>And that‚Äôs it!</p>
</section>
</section>
<section id="epilogue" class="level2">
<h2 class="anchored" data-anchor-id="epilogue">Epilogue</h2>
<p>A quick note: percentile estimators of the confidence intervals are highly prevalent in the literature and seem widely accepted within the sciences (at least ecology and epidemiology). Albeit, to my knowledge, there is no final proof that these intervals work as intended. <a href="https://www.tandfonline.com/doi/epdf/10.1080/01621459.1988.10478591?needAccess=true">Wu and Rao</a> argue for a different method (the <code>t</code> method). However, <a href="(http://dx.doi.org/10.1214/16-SS113)">Z. Mashreghi et al</a> states: ‚Äúit is not clear that the other types of bootstrap confidence intervals (percentile or t) could be used with either of these methods since they are based on sampling schemes designed to match the variability of the estimator, but not its distribution‚Äù.</p>
</section>
<section id="references" class="level2">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-arnab2017survey" class="csl-entry">
Arnab, Raghunath. 2017. <span>‚ÄúSurvey Sampling Theory and Applications.‚Äù</span> In. Academic Press.
</div>
<div id="ref-mashreghi2016survey" class="csl-entry">
Mashreghi, Zeinab, David Haziza, and Christian L√©ger. 2016. <span>‚ÄúA Survey of Bootstrap Methods in Finite Population Sampling.‚Äù</span>
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>bootstrap</category>
  <category>statistical-inference</category>
  <category>survey analysis</category>
  <category>survey</category>
  <guid>https://rodrigozepeda.github.io/Statisticats/posts/bootstraping-a-survey-regression/index.html</guid>
  <pubDate>Tue, 29 Aug 2023 04:00:00 GMT</pubDate>
  <media:content url="https://rodrigozepeda.github.io/Statisticats/posts/bootstraping-a-survey-regression/boot.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>An intuitive (geometric) interpretation of the characteristic function of a random variable</title>
  <dc:creator>Rodrigo Zepeda-Tello</dc:creator>
  <link>https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/index.html</link>
  <description><![CDATA[ 



<div class="cell">

</div>
<section id="the-characteristic-function" class="level1">
<h1>The characteristic function</h1>
<p>The characteristic function of a random variable <img src="https://latex.codecogs.com/png.latex?X"> is defined as the Fourier Transform of the variable<sup>1</sup>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cphi_X(t)%20=%20%5Cmathbb%7BE%7D%5Be%5E%7Bi%20t%20X%7D%5D%0A"> One of the first questions that arise during a probability course is, of course, <em>what the @&amp;/¬¨#¬¢! is that?</em> In this post we aim to remedy this and give some physical intuitions behind such a formula.</p>
</section>
<section id="de-finettis-interpretation-as-a-barycentre" class="level1 page-columns page-full">
<h1>De Finetti‚Äôs interpretation as a barycentre</h1>
<p>Bruno de Finetti in one of his lectures (<span class="citation" data-cites="de2008philosophical">De Finetti, Galavotti, and Hosni (2008)</span>) gives my favourite interpretation. He reminds us that for any <img src="https://latex.codecogs.com/png.latex?x">, the complex valued function <img src="https://latex.codecogs.com/png.latex?x%20%5Cto%20e%5E%7Bi%20x%7D">, represents a point along the unit circumference. Hence for a discrete random variable <img src="https://latex.codecogs.com/png.latex?X"> that takes <img src="https://latex.codecogs.com/png.latex?3"> values: <img src="https://latex.codecogs.com/png.latex?x_1,%20x_2,%20x_3"> with probabilities <img src="https://latex.codecogs.com/png.latex?p_1,%20p_2,%20p_3">, the characteristic function at <img src="https://latex.codecogs.com/png.latex?1"> is given by the weighted average of three points in the unit circumference:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cphi_X(1)%20=%20%5Cmathbb%7BE%7D%5Be%5E%7BiX%7D%5D%20=%20%5Csum%5Climits_%7Bk=1%7D%5E3%20p_k%20e%5E%7Bi%20x_k%7D%0A"></p>
<p>We can think of each <img src="https://latex.codecogs.com/png.latex?x_k"> as pulling the unit disk by <img src="https://latex.codecogs.com/png.latex?p_k"> in their respective direction (red dots). The center of mass (barycenter) of the unit disc will lie in <img src="https://latex.codecogs.com/png.latex?%5Cphi_X(1)"> (black triangle):</p>
<div class="cell" data-layout-align="center">

</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/barycentre.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption margin-caption">The barycenter is calculated as if each <img src="https://latex.codecogs.com/png.latex?x_k"> pulled the center of the disk by <img src="https://latex.codecogs.com/png.latex?p_k">.</figcaption><p></p>
</figure>
</div>
<p>Any rotation by an angle <img src="https://latex.codecogs.com/png.latex?t"> will move the barycenter accordingly as the points <img src="https://latex.codecogs.com/png.latex?e%5E%7Bi%20t%20x_k%7D"> will still lie in the unit circle. The path followed by the barycenter is nothing more than <img src="https://latex.codecogs.com/png.latex?phi(t)">.</p>
<div class="cell" data-layout-align="center">

</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/circle.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption margin-caption">Animation of a the barycentre <img src="https://latex.codecogs.com/png.latex?%5Cphi(t)"> (black triangle) as <img src="https://latex.codecogs.com/png.latex?t"> changes. You can see each <img src="https://latex.codecogs.com/png.latex?x_k"> pulling by <img src="https://latex.codecogs.com/png.latex?p_k"> the barycenter as <img src="https://latex.codecogs.com/png.latex?t"> varies.</figcaption><p></p>
</figure>
</div>
<p>Hence the characteristic function can be thought of as a the function that calculates the center of mass resulting from <img src="https://latex.codecogs.com/png.latex?X"> after each rotation <img src="https://latex.codecogs.com/png.latex?t">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cphi_X(t)%20=%20%5Cmathbb%7BE%7D%5Be%5E%7Bi%20t%20X%7D%5D%20=%20%5Csum%5Climits_%7Bk=1%7D%5E3%20p_k%20e%5E%7Bi%20t%20x_k%7D.%0A"></p>
<p>For a continuous random variable we can think of a unit circle with mass all around its circumference. The characteristic function continues to be the center of mass. As the function <img src="https://latex.codecogs.com/png.latex?t%20%5Cto%20%5Cmathbb%7BE%7D%5Be%5E%7Bi%20t%20X%7D%5D"> returns the coordinates of the barycenter for each <img src="https://latex.codecogs.com/png.latex?t"> we can think of the characteristic function as a change of coordinates from ‚Äúclassic‚Äù to ‚Äúbarycenters‚Äù. Sean Carroll characterizes it this way: <a href="https://www.preposterousuniverse.com/blog/2014/11/27/thanksgiving-9/">[the characteristic function] ‚Äúis just a fancy change of coordinates‚Äù</a>.</p>
<p>There are a lot of properties that follow from this interpretation:</p>
<ol type="1">
<li><p>Existance is given as if <img src="https://latex.codecogs.com/png.latex?X"> exists then <img src="https://latex.codecogs.com/png.latex?e%5E%7BitX%7D"> exists and <em>is bounded</em> (see 3). Hence the average <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5Be%5E%7Bi%20t%20X%7D%5D"> also exists.</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?%5Cphi(0)%20=%201"> as <img src="https://latex.codecogs.com/png.latex?e%5E0"> lies on the circumference at <img src="https://latex.codecogs.com/png.latex?(1,0)">.</p></li>
<li><p>That the function is bounded by one, <img src="https://latex.codecogs.com/png.latex?%7C%5Cphi(t)%7C%20%5Cleq%201">, follows from its characterization as a path of barycenters inside the unit circle.</p></li>
<li><p>If <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> are independent then <img src="https://latex.codecogs.com/png.latex?%5Cphi_%7BX,Y%7D(s,t)"> is a rotation of <img src="https://latex.codecogs.com/png.latex?X"> by <img src="https://latex.codecogs.com/png.latex?s"> and of <img src="https://latex.codecogs.com/png.latex?Y"> by <img src="https://latex.codecogs.com/png.latex?t">. Their independence ensures that rotating one doesn‚Äôt rotate the other, hence <img src="https://latex.codecogs.com/png.latex?%5Cphi_%7BX,Y%7D(s,t)%20=%20%5Cphi_%7BX%7D(s)%5Cphi_%7BY%7D(t)">.</p></li>
<li><p>By the same argument, if <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> are independent, rotating <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> separately and then adding their masses results in the same barycenter as adding their masses and then rotating the mixture: <img src="https://latex.codecogs.com/png.latex?%5Cphi_%7BX%20+%20Y%7D(t)%20=%20%5Cphi_%7BX%7D(t)%5Cphi_%7BY%7D(t)">.</p></li>
</ol>
<p>We‚Äôll see that this intuition also helps us understand the <strong>inversion theorem</strong>.</p>
<section id="a-geometric-interpretation-of-the-inversion-theorem" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="a-geometric-interpretation-of-the-inversion-theorem">A geometric interpretation of the inversion theorem</h2>
<p>The characteristic function <img src="https://latex.codecogs.com/png.latex?%5Cphi(t)"> corresponds to the path of the barycentre of the circumference as the points around it rotate by <img src="https://latex.codecogs.com/png.latex?t">. This represents a unique signature<sup>2</sup>:</p>
<div class="cell" data-layout-align="center">

</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/barycentre_path.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption margin-caption">The path of <img src="https://latex.codecogs.com/png.latex?%5Cphi(t)"> as reconstructed from the three <img src="https://latex.codecogs.com/png.latex?x_k"> represents the random variable‚Äôs unique signature.</figcaption><p></p>
</figure>
</div>
<p>Before going into the inverse transform there remains a second point of interest. As was seen in the previous animation, a fixed <img src="https://latex.codecogs.com/png.latex?x_k"> in <img src="https://latex.codecogs.com/png.latex?e%5E%7Bitx_k%7D"> represents the ‚Äúspeed‚Äù at which the particle (that pulls the barycenter with weight <img src="https://latex.codecogs.com/png.latex?p_k">) travels around the circumference. Intuitively if you think of <img src="https://latex.codecogs.com/png.latex?t"> moving from <img src="https://latex.codecogs.com/png.latex?-%5Cpi"> to <img src="https://latex.codecogs.com/png.latex?%5Cpi">, then <img src="https://latex.codecogs.com/png.latex?x_k%20=%201"> represents the reference speed for traveling around the circumference. Any <img src="https://latex.codecogs.com/png.latex?x_k%20%3E%201"> will result in a path that goes around faster and travels more than a cycle while <img src="https://latex.codecogs.com/png.latex?x_k%20%3C%201"> will not complete a full cycle in the <img src="https://latex.codecogs.com/png.latex?%5B-%5Cpi,%5Cpi%5D"> period.</p>
<p>Now we can go and interpret the inverse fourier transform. By taking <img src="https://latex.codecogs.com/png.latex?%5Cphi(t)"> and multiplying it by <img src="https://latex.codecogs.com/png.latex?e%5E%7B-itx_k%7D"> (for a fixed <img src="https://latex.codecogs.com/png.latex?x_k">) we project outwards from the barycenter. As the angle <img src="https://latex.codecogs.com/png.latex?t"> varies from <img src="https://latex.codecogs.com/png.latex?-%5Cpi"> to <img src="https://latex.codecogs.com/png.latex?%5Cpi">, the barycenter is pulled by a force <img src="https://latex.codecogs.com/png.latex?p_x"> that moves at speed <img src="https://latex.codecogs.com/png.latex?x"> around the circumference.</p>
<div class="cell" data-layout-align="center">

</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/barycentre_path_2.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption margin-caption">Barycenter image 2</figcaption><p></p>
</figure>
</div>
<p>Averaging all around the circumference (<em>i.e.</em> from <img src="https://latex.codecogs.com/png.latex?%5B-%5Cpi,%5Cpi%5D">) returns the average pull that moves at speed <img src="https://latex.codecogs.com/png.latex?x"> and pulls the barycentre in its direction. The normalization of this (dividing by the <img src="https://latex.codecogs.com/png.latex?2%5Cpi"> of the circumference‚Äôs length) corresponds to <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(X%20=x)">.</p>
<p>Hence the inversion theorem for discrete random variables follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BP%7D(X%20=%20x_k)%20=%20%5Cfrac%7B1%7D%7B2%5Cpi%7D%20%5Cint%5Climits_%7B-%5Cpi%7D%5E%7B%5Cpi%7D%20e%5E%7B-itx_k%7D%20%5Cphi(t)%20dt.%0A"></p>
<p>So, what do you think? Has the geometric interpretation helped you in understanding the characteristic function? Let me know!</p>
</section>
</section>
<section id="references" class="level1">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-de2008philosophical" class="csl-entry">
De Finetti, Bruno, Maria Carla Galavotti, and Hykel Hosni. 2008. <em>Philosophical Lectures on Probability</em>. Springer.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The classical Fourier transform has a <img src="https://latex.codecogs.com/png.latex?2%5Cpi"> but in probability we assume <img src="https://latex.codecogs.com/png.latex?t%20=%202%5Cpi%20%5Ctheta"> for some <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> and forget about <img src="https://latex.codecogs.com/png.latex?%5Cpi">.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>And a great mandala to colour!‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>probability</category>
  <category>random variables</category>
  <category>characteristic function</category>
  <category>intuitive math</category>
  <guid>https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/index.html</guid>
  <pubDate>Fri, 06 Jan 2023 05:00:00 GMT</pubDate>
  <media:content url="https://rodrigozepeda.github.io/Statisticats/posts/characteristic-function-definetti/barycenter.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>FasteR functions with memoise</title>
  <dc:creator>Rodrigo Zepeda-Tello</dc:creator>
  <link>https://rodrigozepeda.github.io/Statisticats/posts/memoise/index.html</link>
  <description><![CDATA[ 



<section id="hey-stop-calling-me" class="level2">
<h2 class="anchored" data-anchor-id="hey-stop-calling-me">Hey, stop calling me!</h2>
<div class="cell">

</div>
<div class="cell">

</div>
<p>Memoisation is a technique for speeding up functions via <em>memorization</em> of previously calculated results. To better explain the idea let‚Äôs consider a recursive formulation of the Fibonacci sequence:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Af(n)%20=%20f(n-%201)%20+%20f(n-2)%0A"></p>
<p>with <img src="https://latex.codecogs.com/png.latex?f(1)%20=%201%20=%20f(2)">. <sup>1</sup></p>
<p>An implementation of the function is given by:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">fibonacci <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(n){</span>
<span id="cb1-2">  <span class="cf" style="color: #003B4F;">if</span>(n <span class="sc" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">2</span>){</span>
<span id="cb1-3">    <span class="fu" style="color: #4758AB;">return</span>(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb1-4">  } <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb1-5">    <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb1-6">      <span class="fu" style="color: #4758AB;">fibonacci</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">fibonacci</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb1-7">    )</span>
<span id="cb1-8">  }</span>
<span id="cb1-9">}</span></code></pre></div>
</div>
<p>We can calculate the time it takes to estimate the number up to <code>20</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">fibonacci</span>(<span class="dv" style="color: #AD0000;">20</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
          expr      min       lq    mean   median       uq      max neval
 fibonacci(20) 4.633172 5.810971 6.92568 6.418399 7.803796 17.74069   100</code></pre>
</div>
</div>
<p>Larger values (like <code>fibonacci(100)</code>) start taking <em>a lot of time</em>. And that‚Äôs because <code>fibonacci(100)</code> estimates the same values several times! To illustrate this point, consider <code>fibonacci(5)</code>. You can see that <code>fibonacci(3)</code> is estimated twice: once under <code>fibonacci(5)</code> itself and one under <code>fibonacci(4)</code>. This is extremely inefficient!</p>
<div class="cell">
<div class="cell-output-display">
<div>
<p>
</p><pre class="mermaid" data-tooltip-selector="#mermaid-tooltip-1">graph TD
    f5[fibonacci 5] --&gt; f4[fibonacci 4]
    f5[fibonacci 5] --&gt; f3[fibonacci 3]
    f3 --&gt; f13[fibonacci 1]
    f3 --&gt; f23[fibonacci 2]
    f4 --&gt; f32[fibonacci 3]
    f4 --&gt; f2[fibonacci 2]
    f32 --&gt; f21[fibonacci 2]
    f32 --&gt; f11[fibonacci 1]
</pre>
<div id="mermaid-tooltip-1" class="mermaidTooltip">

</div>
<p></p>
</div>
</div>
</div>
<p>We can calculate how many times the function <code>fibonacci</code> is called when estimating different numbers. In theory it should scale linearly <em>i.e.</em> <code>fibonacci(20)</code> should only calculate <code>fibonacci(1)</code>, <code>fibonacci(2)</code>, etc up to <code>fibonacci(19)</code> <em>once</em>. Hence the function should be called at most 20 times. However this isn‚Äôt the case:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">calls_f   <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb4-2">fibonacci_calls <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(n){</span>
<span id="cb4-3">  calls_f <span class="ot" style="color: #003B4F;">&lt;&lt;-</span> calls_f <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb4-4">  <span class="cf" style="color: #003B4F;">if</span>(n <span class="sc" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">2</span>){</span>
<span id="cb4-5">    <span class="fu" style="color: #4758AB;">return</span>(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb4-6">  } <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb4-7">    <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb4-8">      <span class="fu" style="color: #4758AB;">fibonacci_calls</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">fibonacci_calls</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb4-9">    )</span>
<span id="cb4-10">  }</span>
<span id="cb4-11">}</span>
<span id="cb4-12"><span class="fu" style="color: #4758AB;">invisible</span>(<span class="fu" style="color: #4758AB;">fibonacci_calls</span>(<span class="dv" style="color: #AD0000;">20</span>))</span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="fu" style="color: #4758AB;">cat</span>(<span class="fu" style="color: #4758AB;">paste</span>(<span class="st" style="color: #20794D;">"fibonacci_calls was called"</span>,calls_f,<span class="st" style="color: #20794D;">"times"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fibonacci_calls was called 13529 times</code></pre>
</div>
</div>
<p>The algorithm is extremely inefficient because it doesn‚Äôt remember when estimating <code>fibonacci_calls(8)</code> that it already has estimated <code>fibonacci_calls(7)</code> during its estimation of <code>fibonacci_calls(9)</code>. Memoisation is a solution for this forgetfulness.</p>
</section>
<section id="sec-hard-coded" class="level2">
<h2 class="anchored" data-anchor-id="sec-hard-coded">Hard coded memoisation</h2>
<p>As we have seen, <code>fibonacci(20)</code> calls the <code>fibonacci</code> function 13,529 times. This inefficiency could be saved if the function could <em>memorize</em> that it has already calculated the previous results. That is the utility of the memoisation trick. To save these memorizations (memoise!), let‚Äôs create a global vector where we‚Äôll keep the previous results of the <code>fibonacci</code> function. That is, the <code>j</code>-th entry of our vector will correspond to <code>fibonacci(j)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;">#Fibonacci cache vector up til fibonacci 1000 </span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;">#fibonacci_cache[j] = fibonacci(j)</span></span>
<span id="cb6-3">fibonacci_cache <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="cn" style="color: #8f5902;">NA</span>, <span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;">#fibonacci_cache[1] = fibonacci(1) and fibonacci_cache[2] = fibonacci(2) </span></span>
<span id="cb6-6">fibonacci_cache[<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">2</span>] <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-7"></span>
<span id="cb6-8">memoised_fibonacci <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(n){</span>
<span id="cb6-9">  <span class="co" style="color: #5E5E5E;">#Only calculate the values we haven't previously estimated</span></span>
<span id="cb6-10">  <span class="cf" style="color: #003B4F;">if</span> (<span class="fu" style="color: #4758AB;">is.na</span>(fibonacci_cache[n])){</span>
<span id="cb6-11">    fibonacci_cache[n] <span class="ot" style="color: #003B4F;">&lt;&lt;-</span> <span class="fu" style="color: #4758AB;">memoised_fibonacci</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">memoised_fibonacci</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb6-12">  } </span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;">return</span>(fibonacci_cache[n])</span>
<span id="cb6-14">}</span></code></pre></div>
</div>
<div class="cell">

</div>
<p>Let‚Äôs compare the speed of the previous function with this one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">fibonacci</span>(<span class="dv" style="color: #AD0000;">20</span>), <span class="fu" style="color: #4758AB;">memoised_fibonacci</span>(<span class="dv" style="color: #AD0000;">20</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: nanoseconds
                   expr     min        lq       mean    median      uq     max
          fibonacci(20) 3942361 4796700.5 5059247.18 4838703.0 4977222 8489579
 memoised_fibonacci(20)     398     589.5    2730.04    1642.5    3855   28640
 neval
   100
   100</code></pre>
</div>
</div>
<p>This speed-up happens because the <em>new</em> <code>memoised_fibonacci</code> only calculates the value <code>18</code> times! In contrast with the previous 13,529. For any custom function you build you can <code>memoise</code> this way <em>ooooor</em> you can let the <code>memoise</code> package do it for you.</p>
</section>
<section id="the-memoise-package" class="level2">
<h2 class="anchored" data-anchor-id="the-memoise-package">The <code>memoise</code> package</h2>
<p>The <code>memoise</code> package does exactly what we did in the previous section by automatically memoising functions (with arguments that aren‚Äôt necessarily numbers). It sets limits to the memory (our <code>fibonacci_cache</code>) as well as the amount of time a function <em>will remember</em> previous results (time limit). To memoise a function you just need to call <code>memoise</code> over it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">library</span>(memoise)</span>
<span id="cb9-2">mfibo <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(n){</span>
<span id="cb9-3">  <span class="cf" style="color: #003B4F;">if</span>(n <span class="sc" style="color: #5E5E5E;">&lt;=</span> <span class="dv" style="color: #AD0000;">2</span>){</span>
<span id="cb9-4">    <span class="fu" style="color: #4758AB;">return</span>(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb9-5">  } <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb9-6">    <span class="fu" style="color: #4758AB;">return</span>(</span>
<span id="cb9-7">      <span class="fu" style="color: #4758AB;">mfibo</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">mfibo</span>(n <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="co" style="color: #5E5E5E;">#It's important to call this with the memoized name</span></span>
<span id="cb9-8">    )</span>
<span id="cb9-9">  }</span>
<span id="cb9-10">}</span>
<span id="cb9-11">mfibo <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">memoise</span>(mfibo) <span class="co" style="color: #5E5E5E;">#Memoization line</span></span></code></pre></div>
</div>
<div class="cell">

</div>
<p>Note that this <code>memoisation</code> has additional overhead over the memoisation we did in Section&nbsp;2 because <code>memoise</code> works even for non numeric arguments (which would have failed in our vectorized example). However the speed-up over the original is still there:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">microbenchmark<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">microbenchmark</span>(<span class="fu" style="color: #4758AB;">fibonacci</span>(<span class="dv" style="color: #AD0000;">20</span>), <span class="fu" style="color: #4758AB;">mfibo</span>(<span class="dv" style="color: #AD0000;">20</span>), <span class="fu" style="color: #4758AB;">memoised_fibonacci</span>(<span class="dv" style="color: #AD0000;">20</span>)) </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: nanoseconds
                   expr     min        lq       mean  median        uq      max
          fibonacci(20) 5291457 6031574.5 7138627.87 6599172 7929635.0 14128101
              mfibo(20)   58632   72422.5  151487.39  139772  190614.5   569502
 memoised_fibonacci(20)     606    1206.0    5186.56    3470    7506.5    39376
 neval
   100
   100
   100</code></pre>
</div>
</div>
<p>The <code>memoise</code> package uses <a href="https://cachem.r-lib.org/">cachem</a> which allows for fine control over where the previous results of the function. You can substitute the <code>#Memoization line</code> in the previous code for this memoise with finer control.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;">#Set memory to 100MB and time to memorizing only for 15 minutes</span></span>
<span id="cb12-2">cm    <span class="ot" style="color: #003B4F;">&lt;-</span> cachem<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">cache_mem</span>(<span class="at" style="color: #657422;">max_size =</span> <span class="dv" style="color: #AD0000;">100</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">1024</span><span class="sc" style="color: #5E5E5E;">^</span><span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">max_age =</span> <span class="dv" style="color: #AD0000;">15</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">60</span>)</span>
<span id="cb12-3">mfibo <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">memoise</span>(mfibo, <span class="at" style="color: #657422;">cache =</span> cm)</span></code></pre></div>
</div>
<p>To keep previous computations across different R sessions you can cache directly to disk (slower) instead of memory:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">cm    <span class="ot" style="color: #003B4F;">&lt;-</span> cachem<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">cache_disk</span>(<span class="at" style="color: #657422;">max_size =</span> <span class="dv" style="color: #AD0000;">100</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">1024</span><span class="sc" style="color: #5E5E5E;">^</span><span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">max_age =</span> <span class="dv" style="color: #AD0000;">15</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">60</span>)</span>
<span id="cb13-2">mfibo <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">memoise</span>(mfibo, <span class="at" style="color: #657422;">cache =</span> cm)</span></code></pre></div>
</div>
</section>
<section id="and-in-other-languages" class="level2">
<h2 class="anchored" data-anchor-id="and-in-other-languages">And in other languages?</h2>
<p>You can also memoise in <a href="https://docs.python.org/3/library/functools.html#functools.cache">the most recent versions of Python</a> either vie the built in <code>functools</code> or the <a href="https://github.com/lonelyenvoy/python-memoization"><code>memoization</code> project</a>. In <a href="https://github.com/JuliaCollections/Memoize.jl">Julia you can Memoize.jl</a>. Let me know if you are interested in an entry for any of these.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Some definitions start with <img src="https://latex.codecogs.com/png.latex?f(0)"> but as <code>R</code> indexes vectors in <img src="https://latex.codecogs.com/png.latex?1"> we‚Äôd better start with <img src="https://latex.codecogs.com/png.latex?1">.‚Ü©Ô∏é</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>memoise</category>
  <category>Advanced R / R avanzado</category>
  <category>programming tips / tips de programaci√≥n</category>
  <guid>https://rodrigozepeda.github.io/Statisticats/posts/memoise/index.html</guid>
  <pubDate>Tue, 27 Dec 2022 05:00:00 GMT</pubDate>
  <media:content url="https://rodrigozepeda.github.io/Statisticats/posts/memoise/memoise.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Navidad/Christmas @ #rstats</title>
  <dc:creator>Rodrigo Zepeda-Tello</dc:creator>
  <link>https://rodrigozepeda.github.io/Statisticats/posts/Navidad/index.html</link>
  <description><![CDATA[ 



<div class="cell">

</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
English tutorial
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the tutorial in English go to Section&nbsp;2.</p>
</div>
</div>
<section id="sec-spanish-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="sec-spanish-tutorial">Tutorial en espa√±ol</h2>
<p>Esta Navidad las <a href="https://rladies.org/mexico-rladies/">Rladies</a> de Quer√©taro hicieron un concurso para realizar un √°rbol de Navidad con R y decid√≠ participar. Esta vez no quer√≠a hacer el t√≠pico arbolito con <code>ggplot2</code> as√≠ que decid√≠ probar otra tecnolog√≠a: <a href="https://www.rayrender.net/"><code>rayrender</code></a>.</p>
<p><code>rayrender</code> es una librer√≠a para crear im√°genes 3D mediante <a href="https://es.wikipedia.org/wiki/Trazado_de_rayos">trazado de rayos</a> (raytracing). No es la <a href="https://www.blender.org/">mejor opci√≥n open source para la tarea</a> pero ¬°hey est√° en R!</p>
<p>La forma en la que <code>rayrender</code> funciona es consturyendo una escena y a partir de √©sta agregar objetos a la escena. Podemos empezar con una escena vac√≠a de estudio fotogr√°fico:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(rayrender)</span>
<span id="cb1-2">scene_test <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">generate_studio</span>(<span class="at" style="color: #657422;">depth =</span> <span class="fl" style="color: #AD0000;">0.2</span>, </span>
<span id="cb1-3">                         <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">checkercolor =</span> <span class="st" style="color: #20794D;">"red"</span>))</span></code></pre></div>
</div>
<p>Para poder ver previsualizar la escena se utiliza <code>render_scene</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">render_scene</span>(scene_test, </span>
<span id="cb2-2">             <span class="at" style="color: #657422;">samples =</span> <span class="dv" style="color: #AD0000;">100</span>, <span class="co" style="color: #5E5E5E;">#Muestras (+ muestras menos ruido)</span></span>
<span id="cb2-3">             <span class="at" style="color: #657422;">preview =</span> T,   <span class="co" style="color: #5E5E5E;">#Si quieres previsualizar la escena antes de calcular</span></span>
<span id="cb2-4">             <span class="at" style="color: #657422;">parallel =</span> T   <span class="co" style="color: #5E5E5E;">#Si realizar el c√≥mputo en paralelo</span></span>
<span id="cb2-5">             )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Sobre la escena podemos agregar objetos con <code>add_object</code>. En particular podemos agregar un cilindro para el tronco especificando sus coordenadas as√≠ como el material:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">scene_test <span class="ot" style="color: #003B4F;">&lt;-</span> scene_test <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb3-3">    <span class="fu" style="color: #4758AB;">cylinder</span>(</span>
<span id="cb3-4">      <span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb3-5">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb3-6">      <span class="at" style="color: #657422;">z =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb3-7">      <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.25</span>,</span>
<span id="cb3-8">      <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">10</span>,</span>
<span id="cb3-9">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#725c42"</span>)</span>
<span id="cb3-10">    )</span>
<span id="cb3-11">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_2.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Hay diferentes materiales, por ejemplo <code>metal</code>, cabello <code>hair</code>, luz <code>light</code>, cristal <code>dielectric</code>, etc (la lista completa en <a href="https://www.rayrender.net/reference/index.html">el apartado materials</a>) por lo que si quisi√©ramos hacer nuestro √°rbol de cristal bastar√≠a cambiar el material:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">scene_metal <span class="ot" style="color: #003B4F;">&lt;-</span> scene_test <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb4-3">    <span class="fu" style="color: #4758AB;">cylinder</span>(</span>
<span id="cb4-4">      <span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb4-5">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb4-6">      <span class="at" style="color: #657422;">z =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb4-7">      <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.25</span>,</span>
<span id="cb4-8">      <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">10</span>,</span>
<span id="cb4-9">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">metal</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#725c42"</span>)</span>
<span id="cb4-10">    )</span>
<span id="cb4-11">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_3.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Podemos cambiar la perspectiva de la c√°mara ajustando manualmente y dando <code>p</code> para obtener las coordenadas y luego imputarlas en el render:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">render_scene</span>(scene_metal, </span>
<span id="cb5-2">             <span class="at" style="color: #657422;">samples =</span> <span class="dv" style="color: #AD0000;">100</span>, </span>
<span id="cb5-3">             <span class="at" style="color: #657422;">preview =</span> T, </span>
<span id="cb5-4">             <span class="at" style="color: #657422;">parallel =</span> T,</span>
<span id="cb5-5">             <span class="at" style="color: #657422;">lookfrom =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">50.10</span>, <span class="fl" style="color: #AD0000;">7.25</span>, <span class="fl" style="color: #AD0000;">60.13</span>), <span class="co" style="color: #5E5E5E;">#D√≥nde est√° la c√°mara</span></span>
<span id="cb5-6">             <span class="at" style="color: #657422;">lookat   =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">5</span>, <span class="dv" style="color: #AD0000;">0</span>), <span class="co" style="color: #5E5E5E;">#D√≥nde est√° viendo la c√°mara</span></span>
<span id="cb5-7">             <span class="at" style="color: #657422;">aperture =</span> <span class="fl" style="color: #AD0000;">0.5</span>, <span class="co" style="color: #5E5E5E;">#Apertura </span></span>
<span id="cb5-8">             <span class="at" style="color: #657422;">fov =</span> <span class="dv" style="color: #AD0000;">17</span>,</span>
<span id="cb5-9">             <span class="at" style="color: #657422;">focal_distance =</span> <span class="fl" style="color: #AD0000;">77.66</span>, <span class="co" style="color: #5E5E5E;">#Distancia focal</span></span>
<span id="cb5-10">             <span class="at" style="color: #657422;">iso =</span> <span class="dv" style="color: #AD0000;">400</span>, <span class="co" style="color: #5E5E5E;">#Sensibilidad "del rollo fotogr√°fico" a la luz </span></span>
<span id="cb5-11">             <span class="at" style="color: #657422;">clamp_value =</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb5-12">             )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_4.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Sobre nuestro √°rbol podemos agregar conos verdes. Agregamos varios conos en un <code>loop</code> para darle mayor figura. Lo pondremos sobre un nuevo fondo (blanco) y con el tronco que hicimos previamente usando <code>diffuse</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">scene <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">generate_studio</span>(<span class="at" style="color: #657422;">depth =</span> <span class="fl" style="color: #AD0000;">0.2</span>) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb6-3">    <span class="fu" style="color: #4758AB;">cylinder</span>(</span>
<span id="cb6-4">      <span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb6-5">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb6-6">      <span class="at" style="color: #657422;">z =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb6-7">      <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.25</span>,</span>
<span id="cb6-8">      <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">10</span>,</span>
<span id="cb6-9">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#725c42"</span>)</span>
<span id="cb6-10">    )</span>
<span id="cb6-11">  ) </span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;">#Conos</span></span>
<span id="cb6-14"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">10</span>, <span class="at" style="color: #657422;">length.out =</span> <span class="dv" style="color: #AD0000;">20</span>)){</span>
<span id="cb6-15">  scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb6-16">    <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb6-17">      <span class="fu" style="color: #4758AB;">cone</span>(</span>
<span id="cb6-18">        <span class="at" style="color: #657422;">start  =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">0</span>),</span>
<span id="cb6-19">        <span class="at" style="color: #657422;">end    =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> (i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>), <span class="dv" style="color: #AD0000;">0</span>),</span>
<span id="cb6-20">        <span class="at" style="color: #657422;">radius =</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb6-21">        <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"darkgreen"</span>)</span>
<span id="cb6-22">      )</span>
<span id="cb6-23">    )</span>
<span id="cb6-24">}</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_5.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Finalmente agregamos esferas luminosas de dos colores distintos: amarillas y rojas sobre las superficies de los conos aleatoriamente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">27522</span>)</span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;">#Esferas luminosas</span></span>
<span id="cb7-3"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">10</span>, <span class="at" style="color: #657422;">length.out =</span> <span class="dv" style="color: #AD0000;">20</span>)){</span>
<span id="cb7-4">  <span class="co" style="color: #5E5E5E;">#Esferas rojas</span></span>
<span id="cb7-5">  <span class="cf" style="color: #003B4F;">for</span> (k <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">runif</span>(<span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>i, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>pi)){</span>
<span id="cb7-6">  scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb7-7">    <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb7-8">      <span class="fu" style="color: #4758AB;">sphere</span>(</span>
<span id="cb7-9">        <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.1</span>,</span>
<span id="cb7-10">        <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>,    <span class="co" style="color: #5E5E5E;">#Altura de la esfera</span></span>
<span id="cb7-11">        <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">cos</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>, <span class="co" style="color: #5E5E5E;">#Coordenadas polares para superficie de cono</span></span>
<span id="cb7-12">        <span class="at" style="color: #657422;">z =</span> <span class="fu" style="color: #4758AB;">sin</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb7-13">        <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">light</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"red"</span>, <span class="at" style="color: #657422;">intensity =</span> <span class="dv" style="color: #AD0000;">5</span>)</span>
<span id="cb7-14">      )</span>
<span id="cb7-15">    )</span>
<span id="cb7-16">  }</span>
<span id="cb7-17">  <span class="co" style="color: #5E5E5E;">#Esferas amarillas</span></span>
<span id="cb7-18">  <span class="cf" style="color: #003B4F;">for</span> (k <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">runif</span>(<span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>i, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>pi)){</span>
<span id="cb7-19">  scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb7-20">    <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb7-21">      <span class="fu" style="color: #4758AB;">sphere</span>(</span>
<span id="cb7-22">        <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.1</span>,</span>
<span id="cb7-23">        <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>,    <span class="co" style="color: #5E5E5E;">#Altura de la esfera</span></span>
<span id="cb7-24">        <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">cos</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>, <span class="co" style="color: #5E5E5E;">#Coordenadas polares para superficie de cono</span></span>
<span id="cb7-25">        <span class="at" style="color: #657422;">z =</span> <span class="fu" style="color: #4758AB;">sin</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb7-26">        <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">light</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#f8d568"</span>, <span class="at" style="color: #657422;">intensity =</span> <span class="dv" style="color: #AD0000;">5</span>)</span>
<span id="cb7-27">      )</span>
<span id="cb7-28">    )</span>
<span id="cb7-29">  }</span>
<span id="cb7-30">}</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_6.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>La estrella se agrega hasta arriba con un pol√≠gono <code>extruded_polygon</code> que permite dise√±ar figuras.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;">#Adaptado de la estrella de https://www.rayrender.net/index.html</span></span>
<span id="cb8-2">angulos  <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>pi, <span class="at" style="color: #657422;">length.out =</span> <span class="dv" style="color: #AD0000;">11</span>)</span>
<span id="cb8-3">x        <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rev</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="fl" style="color: #AD0000;">0.5</span>), <span class="dv" style="color: #AD0000;">5</span>), <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">cos</span>(angulos)</span>
<span id="cb8-4">z        <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rev</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="fl" style="color: #AD0000;">0.5</span>), <span class="dv" style="color: #AD0000;">5</span>), <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">sin</span>(angulos)</span>
<span id="cb8-5">poligono <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">x =</span> x, <span class="at" style="color: #657422;">z =</span> z)</span>
<span id="cb8-6">estrella <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rbind</span>(poligono, <span class="fl" style="color: #AD0000;">0.8</span><span class="sc" style="color: #5E5E5E;">*</span>poligono)</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;">#Agregamos la estrella luminosa a la escena</span></span>
<span id="cb8-9">scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb8-11">    <span class="fu" style="color: #4758AB;">extruded_polygon</span>(</span>
<span id="cb8-12">      estrella,</span>
<span id="cb8-13">      <span class="at" style="color: #657422;">top =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span id="cb8-14">      <span class="at" style="color: #657422;">bottom =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb8-15">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">7</span>,    <span class="co" style="color: #5E5E5E;">#Altura</span></span>
<span id="cb8-16">      <span class="at" style="color: #657422;">z =</span> <span class="fl" style="color: #AD0000;">0.75</span>, <span class="co" style="color: #5E5E5E;">#Centrar</span></span>
<span id="cb8-17">      <span class="at" style="color: #657422;">angle =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">90</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">90</span>),</span>
<span id="cb8-18">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">light</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"white"</span>)</span>
<span id="cb8-19">    )</span>
<span id="cb8-20">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_7.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Una vez que est√° listo nuestro √°rbol nos preparamos para renderizarlo con suficientes muestras para eliminar todo el ruido:</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>√âste proceso tarda varias horas</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">png</span>(<span class="st" style="color: #20794D;">"arbolito.png"</span>)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;">render_scene</span>(scene, </span>
<span id="cb9-3">             <span class="at" style="color: #657422;">width =</span> <span class="dv" style="color: #AD0000;">500</span>,    <span class="co" style="color: #5E5E5E;">#Ancho en pixeles</span></span>
<span id="cb9-4">             <span class="at" style="color: #657422;">height =</span> <span class="dv" style="color: #AD0000;">500</span>,   <span class="co" style="color: #5E5E5E;">#Alto en pixeles</span></span>
<span id="cb9-5">             <span class="at" style="color: #657422;">samples =</span> <span class="dv" style="color: #AD0000;">1000</span>, <span class="co" style="color: #5E5E5E;">#Suficientes muestras!</span></span>
<span id="cb9-6">             <span class="at" style="color: #657422;">preview =</span> F, </span>
<span id="cb9-7">             <span class="at" style="color: #657422;">parallel =</span> T,</span>
<span id="cb9-8">             <span class="at" style="color: #657422;">lookfrom =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">50.10</span>, <span class="fl" style="color: #AD0000;">7.25</span>, <span class="fl" style="color: #AD0000;">60.13</span>), </span>
<span id="cb9-9">             <span class="at" style="color: #657422;">lookat   =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">5</span>, <span class="dv" style="color: #AD0000;">0</span>), </span>
<span id="cb9-10">             <span class="at" style="color: #657422;">aperture =</span> <span class="fl" style="color: #AD0000;">0.5</span>, </span>
<span id="cb9-11">             <span class="at" style="color: #657422;">fov =</span> <span class="dv" style="color: #AD0000;">17</span>,</span>
<span id="cb9-12">             <span class="at" style="color: #657422;">focal_distance =</span> <span class="fl" style="color: #AD0000;">77.66</span>,</span>
<span id="cb9-13">             <span class="at" style="color: #657422;">iso =</span> <span class="dv" style="color: #AD0000;">400</span>, </span>
<span id="cb9-14">             <span class="at" style="color: #657422;">clamp_value =</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb9-15">             )</span>
<span id="cb9-16"><span class="fu" style="color: #4758AB;">dev.off</span>()</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/arbolito.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Finalmente al arbolito le agregamos texto de <code>Feliz Navidad</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;">library</span>(png)</span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;">library</span>(showtext)</span>
<span id="cb10-3"><span class="fu" style="color: #4758AB;">library</span>(cowplot)</span>
<span id="cb10-4"><span class="fu" style="color: #4758AB;">library</span>(ggplot2)</span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;">#Descarga de la fuente Passions Conflict</span></span>
<span id="cb10-7"><span class="fu" style="color: #4758AB;">font_add_google</span>(<span class="st" style="color: #20794D;">"Passions Conflict"</span>, <span class="st" style="color: #20794D;">"pconflict"</span>)</span>
<span id="cb10-8"><span class="fu" style="color: #4758AB;">showtext_auto</span>()</span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;">#Leemos la imagen</span></span>
<span id="cb10-11">arbol <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">readPNG</span>(<span class="st" style="color: #20794D;">"arbolito.png"</span>)</span>
<span id="cb10-12"></span>
<span id="cb10-13">drawplot <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggdraw</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;">annotation_raster</span>(arbol, <span class="at" style="color: #657422;">xmin =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">ymin =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">xmax =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">ymax =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-15">  <span class="fu" style="color: #4758AB;">geom_text</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> <span class="fl" style="color: #AD0000;">0.5</span>, <span class="at" style="color: #657422;">y =</span> <span class="fl" style="color: #AD0000;">0.1</span>, <span class="at" style="color: #657422;">label =</span> <span class="st" style="color: #20794D;">"Feliz Navidad"</span>), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span id="cb10-16">            <span class="at" style="color: #657422;">family =</span> <span class="st" style="color: #20794D;">"pconflict"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">15</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-17">  <span class="fu" style="color: #4758AB;">geom_text</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> <span class="fl" style="color: #AD0000;">0.5</span>, <span class="at" style="color: #657422;">y =</span> <span class="fl" style="color: #AD0000;">0.95</span>,</span>
<span id="cb10-18">                <span class="at" style="color: #657422;">label =</span> <span class="st" style="color: #20794D;">"@RodZepeda | rodrigozepeda.github.io/Statisticats/posts/Navidad"</span>),</span>
<span id="cb10-19">            <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"gray75"</span>,</span>
<span id="cb10-20">            <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">3</span>) </span>
<span id="cb10-21"><span class="fu" style="color: #4758AB;">ggsave</span>(<span class="st" style="color: #20794D;">"arbolito_navidad_2022_es.png"</span>, drawplot, <span class="at" style="color: #657422;">dpi =</span> <span class="dv" style="color: #AD0000;">100</span>, <span class="at" style="color: #657422;">width =</span> <span class="dv" style="color: #AD0000;">500</span>, <span class="at" style="color: #657422;">height =</span> <span class="dv" style="color: #AD0000;">500</span>, <span class="at" style="color: #657422;">units =</span> <span class="st" style="color: #20794D;">"px"</span>)  </span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/arbolito_navidad_2022_es.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-english-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="sec-english-tutorial">Tutorial in English</h2>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tutorial en espa√±ol
</div>
</div>
<div class="callout-body-container callout-body">
<p>Para el tutorial en espa√±ol ve a Section&nbsp;1.</p>
</div>
</div>
<p>This Christmas <a href="https://rladies.org/mexico-rladies/">Rladies</a> Quer√©taro created a contest. One was to build a Christmas tree in <code>R</code>. I decided to participate. This time I didn‚Äôt want to do the typical <code>ggplot2</code> tree so I decided to test another technology: <a href="https://www.rayrender.net/"><code>rayrender</code></a>.</p>
<p><code>rayrender</code> is a library to create 3D images using raytracing. This is not <a href="https://www.blender.org/">the best open source option for this task</a>, but hey, it‚Äôs in R!</p>
<p>The way <code>rayrender</code> works is by building a scene and adding objects to it. We can start with an empty study scene:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;">library</span>(rayrender)</span>
<span id="cb11-2">scene_test <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">generate_studio</span>(<span class="at" style="color: #657422;">depth =</span> <span class="fl" style="color: #AD0000;">0.2</span>, </span>
<span id="cb11-3">                         <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">checkercolor =</span> <span class="st" style="color: #20794D;">"red"</span>))</span></code></pre></div>
</div>
<p>To preview the scene use <code>render_scene</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;">render_scene</span>(scene_test, </span>
<span id="cb12-2">             <span class="at" style="color: #657422;">samples =</span> <span class="dv" style="color: #AD0000;">100</span>, <span class="co" style="color: #5E5E5E;">#More samples less noise</span></span>
<span id="cb12-3">             <span class="at" style="color: #657422;">preview =</span> T,   <span class="co" style="color: #5E5E5E;">#To preview the scene (before calculating)</span></span>
<span id="cb12-4">             <span class="at" style="color: #657422;">parallel =</span> T   <span class="co" style="color: #5E5E5E;">#Compute in parallel for extra speed</span></span>
<span id="cb12-5">             )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_1.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>We can add different objects onto the scene with <code>add_object</code>. In particular, we can add a cylinder for the tree trunk as well as its coordinates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">scene_test <span class="ot" style="color: #003B4F;">&lt;-</span> scene_test <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb13-3">    <span class="fu" style="color: #4758AB;">cylinder</span>(</span>
<span id="cb13-4">      <span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb13-5">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb13-6">      <span class="at" style="color: #657422;">z =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb13-7">      <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.25</span>,</span>
<span id="cb13-8">      <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">10</span>,</span>
<span id="cb13-9">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#725c42"</span>)</span>
<span id="cb13-10">    )</span>
<span id="cb13-11">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_2.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>There are different materials (e.g.&nbsp;<code>metal</code>, <code>hair</code>, <code>light</code>, (crystal) <code>dielectric</code>, etc see <a href="https://www.rayrender.net/reference/index.html">materials</a>). If we wish to make our tree metal we can just change the material:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">scene_metal <span class="ot" style="color: #003B4F;">&lt;-</span> scene_test <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb14-3">    <span class="fu" style="color: #4758AB;">cylinder</span>(</span>
<span id="cb14-4">      <span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb14-5">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb14-6">      <span class="at" style="color: #657422;">z =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb14-7">      <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.25</span>,</span>
<span id="cb14-8">      <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">10</span>,</span>
<span id="cb14-9">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">metal</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#725c42"</span>)</span>
<span id="cb14-10">    )</span>
<span id="cb14-11">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_3.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>We can shift the camera‚Äôs perspective by manually adjusting and obtain the coordinates with <code>p</code>. These coordinates can be inputed into the render:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;">render_scene</span>(scene_metal, </span>
<span id="cb15-2">             <span class="at" style="color: #657422;">samples =</span> <span class="dv" style="color: #AD0000;">100</span>, </span>
<span id="cb15-3">             <span class="at" style="color: #657422;">preview =</span> T, </span>
<span id="cb15-4">             <span class="at" style="color: #657422;">parallel =</span> T,</span>
<span id="cb15-5">             <span class="at" style="color: #657422;">lookfrom =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">50.10</span>, <span class="fl" style="color: #AD0000;">7.25</span>, <span class="fl" style="color: #AD0000;">60.13</span>), <span class="co" style="color: #5E5E5E;">#Where camera is</span></span>
<span id="cb15-6">             <span class="at" style="color: #657422;">lookat   =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">5</span>, <span class="dv" style="color: #AD0000;">0</span>), <span class="co" style="color: #5E5E5E;">#What is camera watching</span></span>
<span id="cb15-7">             <span class="at" style="color: #657422;">aperture =</span> <span class="fl" style="color: #AD0000;">0.5</span>, </span>
<span id="cb15-8">             <span class="at" style="color: #657422;">fov =</span> <span class="dv" style="color: #AD0000;">17</span>,</span>
<span id="cb15-9">             <span class="at" style="color: #657422;">focal_distance =</span> <span class="fl" style="color: #AD0000;">77.66</span>, </span>
<span id="cb15-10">             <span class="at" style="color: #657422;">iso =</span> <span class="dv" style="color: #AD0000;">400</span>, <span class="co" style="color: #5E5E5E;">#Sensitivity to light</span></span>
<span id="cb15-11">             <span class="at" style="color: #657422;">clamp_value =</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb15-12">             )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_4.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>We can add green cones to our tree. We do that with a <code>for</code> loop. We‚Äôll put that tree over a white background and with the previous trunk we had using <code>diffuse</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">scene <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">generate_studio</span>(<span class="at" style="color: #657422;">depth =</span> <span class="fl" style="color: #AD0000;">0.2</span>) <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb16-3">    <span class="fu" style="color: #4758AB;">cylinder</span>(</span>
<span id="cb16-4">      <span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb16-5">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb16-6">      <span class="at" style="color: #657422;">z =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb16-7">      <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.25</span>,</span>
<span id="cb16-8">      <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">10</span>,</span>
<span id="cb16-9">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#725c42"</span>)</span>
<span id="cb16-10">    )</span>
<span id="cb16-11">  ) </span>
<span id="cb16-12"></span>
<span id="cb16-13"><span class="co" style="color: #5E5E5E;">#Cones</span></span>
<span id="cb16-14"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">10</span>, <span class="at" style="color: #657422;">length.out =</span> <span class="dv" style="color: #AD0000;">20</span>)){</span>
<span id="cb16-15">  scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb16-16">    <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb16-17">      <span class="fu" style="color: #4758AB;">cone</span>(</span>
<span id="cb16-18">        <span class="at" style="color: #657422;">start  =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">0</span>),</span>
<span id="cb16-19">        <span class="at" style="color: #657422;">end    =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> (i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="dv" style="color: #AD0000;">1</span>), <span class="dv" style="color: #AD0000;">0</span>),</span>
<span id="cb16-20">        <span class="at" style="color: #657422;">radius =</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb16-21">        <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">diffuse</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"darkgreen"</span>)</span>
<span id="cb16-22">      )</span>
<span id="cb16-23">    )</span>
<span id="cb16-24">}</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_5.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we add light spheres of two colors: yellow and red. These go randomly over the cone‚Äôs surface.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">27522</span>)</span>
<span id="cb17-2"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">10</span>, <span class="at" style="color: #657422;">length.out =</span> <span class="dv" style="color: #AD0000;">20</span>)){</span>
<span id="cb17-3">  <span class="co" style="color: #5E5E5E;">#Red spheres</span></span>
<span id="cb17-4">  <span class="cf" style="color: #003B4F;">for</span> (k <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">runif</span>(<span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>i, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>pi)){</span>
<span id="cb17-5">  scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb17-6">    <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb17-7">      <span class="fu" style="color: #4758AB;">sphere</span>(</span>
<span id="cb17-8">        <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.1</span>,</span>
<span id="cb17-9">        <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>,    <span class="co" style="color: #5E5E5E;">#Sphere height</span></span>
<span id="cb17-10">        <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">cos</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>, <span class="co" style="color: #5E5E5E;">#Polar coordinates for the cone's surface</span></span>
<span id="cb17-11">        <span class="at" style="color: #657422;">z =</span> <span class="fu" style="color: #4758AB;">sin</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb17-12">        <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">light</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"red"</span>, <span class="at" style="color: #657422;">intensity =</span> <span class="dv" style="color: #AD0000;">5</span>)</span>
<span id="cb17-13">      )</span>
<span id="cb17-14">    )</span>
<span id="cb17-15">  }</span>
<span id="cb17-16">  <span class="co" style="color: #5E5E5E;">#yellow spheres</span></span>
<span id="cb17-17">  <span class="cf" style="color: #003B4F;">for</span> (k <span class="cf" style="color: #003B4F;">in</span> <span class="fu" style="color: #4758AB;">runif</span>(<span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>i, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>pi)){</span>
<span id="cb17-18">  scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span> </span>
<span id="cb17-19">    <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb17-20">      <span class="fu" style="color: #4758AB;">sphere</span>(</span>
<span id="cb17-21">        <span class="at" style="color: #657422;">radius =</span> <span class="fl" style="color: #AD0000;">0.1</span>,</span>
<span id="cb17-22">        <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">6</span> <span class="sc" style="color: #5E5E5E;">-</span> i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">2</span>,    </span>
<span id="cb17-23">        <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">cos</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>, </span>
<span id="cb17-24">        <span class="at" style="color: #657422;">z =</span> <span class="fu" style="color: #4758AB;">sin</span>(k)<span class="sc" style="color: #5E5E5E;">*</span>i<span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb17-25">        <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">light</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#f8d568"</span>, <span class="at" style="color: #657422;">intensity =</span> <span class="dv" style="color: #AD0000;">5</span>)</span>
<span id="cb17-26">      )</span>
<span id="cb17-27">    )</span>
<span id="cb17-28">  }</span>
<span id="cb17-29">}</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_6.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>We add an <code>extruded_polygon</code> for the star:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;">#Adapted from the star at https://www.rayrender.net/index.html</span></span>
<span id="cb18-2">angulos  <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">2</span><span class="sc" style="color: #5E5E5E;">*</span>pi, <span class="at" style="color: #657422;">length.out =</span> <span class="dv" style="color: #AD0000;">11</span>)</span>
<span id="cb18-3">x        <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rev</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="fl" style="color: #AD0000;">0.5</span>), <span class="dv" style="color: #AD0000;">5</span>), <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">cos</span>(angulos)</span>
<span id="cb18-4">z        <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rev</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="fl" style="color: #AD0000;">0.5</span>), <span class="dv" style="color: #AD0000;">5</span>), <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">sin</span>(angulos)</span>
<span id="cb18-5">poligono <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">x =</span> x, <span class="at" style="color: #657422;">z =</span> z)</span>
<span id="cb18-6">estrella <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rbind</span>(poligono, <span class="fl" style="color: #AD0000;">0.8</span><span class="sc" style="color: #5E5E5E;">*</span>poligono)</span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;">#Add the luminous star</span></span>
<span id="cb18-9">scene <span class="ot" style="color: #003B4F;">&lt;-</span> scene <span class="sc" style="color: #5E5E5E;">|&gt;</span></span>
<span id="cb18-10">  <span class="fu" style="color: #4758AB;">add_object</span>(</span>
<span id="cb18-11">    <span class="fu" style="color: #4758AB;">extruded_polygon</span>(</span>
<span id="cb18-12">      estrella,</span>
<span id="cb18-13">      <span class="at" style="color: #657422;">top =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span id="cb18-14">      <span class="at" style="color: #657422;">bottom =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb18-15">      <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">7</span>,    <span class="co" style="color: #5E5E5E;">#Altura</span></span>
<span id="cb18-16">      <span class="at" style="color: #657422;">z =</span> <span class="fl" style="color: #AD0000;">0.75</span>, <span class="co" style="color: #5E5E5E;">#Centrar</span></span>
<span id="cb18-17">      <span class="at" style="color: #657422;">angle =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">90</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">90</span>),</span>
<span id="cb18-18">      <span class="at" style="color: #657422;">material =</span> <span class="fu" style="color: #4758AB;">light</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"white"</span>)</span>
<span id="cb18-19">    )</span>
<span id="cb18-20">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/render_7.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Once our tree is ready we render it with enough samples to eliminate the noise:</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This process takes several hours</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;">png</span>(<span class="st" style="color: #20794D;">"arbolito.png"</span>)</span>
<span id="cb19-2"><span class="fu" style="color: #4758AB;">render_scene</span>(scene, </span>
<span id="cb19-3">             <span class="at" style="color: #657422;">width =</span> <span class="dv" style="color: #AD0000;">500</span>,    <span class="co" style="color: #5E5E5E;">#Pixel width</span></span>
<span id="cb19-4">             <span class="at" style="color: #657422;">height =</span> <span class="dv" style="color: #AD0000;">500</span>,   <span class="co" style="color: #5E5E5E;">#Pixel height</span></span>
<span id="cb19-5">             <span class="at" style="color: #657422;">samples =</span> <span class="dv" style="color: #AD0000;">1000</span>, <span class="co" style="color: #5E5E5E;">#Enough samples</span></span>
<span id="cb19-6">             <span class="at" style="color: #657422;">preview =</span> F, </span>
<span id="cb19-7">             <span class="at" style="color: #657422;">parallel =</span> T,</span>
<span id="cb19-8">             <span class="at" style="color: #657422;">lookfrom =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">50.10</span>, <span class="fl" style="color: #AD0000;">7.25</span>, <span class="fl" style="color: #AD0000;">60.13</span>), </span>
<span id="cb19-9">             <span class="at" style="color: #657422;">lookat   =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">5</span>, <span class="dv" style="color: #AD0000;">0</span>), </span>
<span id="cb19-10">             <span class="at" style="color: #657422;">aperture =</span> <span class="fl" style="color: #AD0000;">0.5</span>, </span>
<span id="cb19-11">             <span class="at" style="color: #657422;">fov =</span> <span class="dv" style="color: #AD0000;">17</span>,</span>
<span id="cb19-12">             <span class="at" style="color: #657422;">focal_distance =</span> <span class="fl" style="color: #AD0000;">77.66</span>,</span>
<span id="cb19-13">             <span class="at" style="color: #657422;">iso =</span> <span class="dv" style="color: #AD0000;">400</span>, </span>
<span id="cb19-14">             <span class="at" style="color: #657422;">clamp_value =</span> <span class="dv" style="color: #AD0000;">10</span></span>
<span id="cb19-15">             )</span>
<span id="cb19-16"><span class="fu" style="color: #4758AB;">dev.off</span>()</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/arbolito.png" class="img-fluid figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
<p>Finally we add <code>Merry Christmas</code> text to the tree</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;">library</span>(png)</span>
<span id="cb20-2"><span class="fu" style="color: #4758AB;">library</span>(showtext)</span>
<span id="cb20-3"><span class="fu" style="color: #4758AB;">library</span>(cowplot)</span>
<span id="cb20-4"><span class="fu" style="color: #4758AB;">library</span>(ggplot2)</span>
<span id="cb20-5"></span>
<span id="cb20-6"><span class="co" style="color: #5E5E5E;">#Download Passions Conflict from google fonts</span></span>
<span id="cb20-7"><span class="fu" style="color: #4758AB;">font_add_google</span>(<span class="st" style="color: #20794D;">"Passions Conflict"</span>, <span class="st" style="color: #20794D;">"pconflict"</span>)</span>
<span id="cb20-8"><span class="fu" style="color: #4758AB;">showtext_auto</span>()</span>
<span id="cb20-9"></span>
<span id="cb20-10"><span class="co" style="color: #5E5E5E;">#Leemos la imagen</span></span>
<span id="cb20-11">arbol <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">readPNG</span>(<span class="st" style="color: #20794D;">"arbolito.png"</span>)</span>
<span id="cb20-12"></span>
<span id="cb20-13">drawplot <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggdraw</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-14">  <span class="fu" style="color: #4758AB;">annotation_raster</span>(arbol, <span class="at" style="color: #657422;">xmin =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">ymin =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">xmax =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">ymax =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-15">  <span class="fu" style="color: #4758AB;">geom_text</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> <span class="fl" style="color: #AD0000;">0.5</span>, <span class="at" style="color: #657422;">y =</span> <span class="fl" style="color: #AD0000;">0.1</span>, <span class="at" style="color: #657422;">label =</span> <span class="st" style="color: #20794D;">"Merry Christmas"</span>), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"white"</span>,</span>
<span id="cb20-16">            <span class="at" style="color: #657422;">family =</span> <span class="st" style="color: #20794D;">"pconflict"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">15</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-17">  <span class="fu" style="color: #4758AB;">geom_text</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> <span class="fl" style="color: #AD0000;">0.5</span>, <span class="at" style="color: #657422;">y =</span> <span class="fl" style="color: #AD0000;">0.95</span>,</span>
<span id="cb20-18">                <span class="at" style="color: #657422;">label =</span> <span class="st" style="color: #20794D;">"@RodZepeda | rodrigozepeda.github.io/Statisticats/posts/Navidad"</span>),</span>
<span id="cb20-19">            <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"gray75"</span>,</span>
<span id="cb20-20">            <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">3</span>) </span>
<span id="cb20-21"><span class="fu" style="color: #4758AB;">ggsave</span>(<span class="st" style="color: #20794D;">"arbolito_navidad_2022_en.png"</span>, drawplot, <span class="at" style="color: #657422;">dpi =</span> <span class="dv" style="color: #AD0000;">100</span>, <span class="at" style="color: #657422;">width =</span> <span class="dv" style="color: #AD0000;">500</span>, <span class="at" style="color: #657422;">height =</span> <span class="dv" style="color: #AD0000;">500</span>, <span class="at" style="color: #657422;">units =</span> <span class="st" style="color: #20794D;">"px"</span>)  </span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/arbolito_navidad_2022_en.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>rayrender</category>
  <category>Navidad / Christmas</category>
  <category>gr√°ficas / plots</category>
  <guid>https://rodrigozepeda.github.io/Statisticats/posts/Navidad/index.html</guid>
  <pubDate>Thu, 22 Dec 2022 05:00:00 GMT</pubDate>
  <media:content url="https://rodrigozepeda.github.io/Statisticats/posts/Navidad/arbolito_navidad_2022_en.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Regresiones (parte 1)</title>
  <dc:creator>Rodrigo Zepeda-Tello</dc:creator>
  <link>https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index.html</link>
  <description><![CDATA[ 



<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/quetelet.jpg" class="img-fluid figure-img" style="width:30.0%" alt="Litograf√≠a de Aldophe Quetelet."></p>
<p></p><figcaption class="figure-caption margin-caption">Adolphe Quetelet fue quien populariz√≥ el uso del m√©todo de m√≠nimos cuadrados en las ciencias sociales. Fuente: <em>Miscellaneous Items in High Demand, PPOC, Library of Congress, Public domain, via Wikimedia Commons</em>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<section id="paquetes-y-datos-a-utilizar-en-r" class="level2">
<h2 class="anchored" data-anchor-id="paquetes-y-datos-a-utilizar-en-r">Paquetes y datos a utilizar en R</h2>
<p>A lo largo de esta secci√≥n usaremos los siguientes paquetes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(tidymodels)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(ggfortify)  <span class="co" style="color: #5E5E5E;">#autoplot para diagn√≥sticos</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(rstanarm)   <span class="co" style="color: #5E5E5E;">#para regresi√≥n bayesiana</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;">#Siempre que uses tidymodels</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;">tidymodels_prefer</span>()</span></code></pre></div>
</div>
<p>En general usaremos la filosof√≠a <code>tidymodels</code> para combinar los resultados con el <code>tidyverse</code>. Si quieres saber m√°s de <code>tidymodels</code> te recomiendo checar <a href="https://www.tmwr.org">su libro</a> o <a href="https://www.tidymodels.org/learn/">su p√°gina web</a>.</p>
<section id="embarazo-adolescente-y-pobreza" class="level3">
<h3 class="anchored" data-anchor-id="embarazo-adolescente-y-pobreza">Embarazo adolescente y pobreza</h3>
<p>Para los datos usaremos la informaci√≥n de <a href="https://online.stat.psu.edu/stat462/sites/onlinecourses.science.psu.edu.stat462/files/data/poverty/index.txt"><em>Utts y Heckard</em></a> para determinar si hay una relaci√≥n entre embarazo adolescente y pobreza.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;">#Lectura desde sitio web</span></span>
<span id="cb2-2">url <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="st" style="color: #20794D;">"https://online.stat.psu.edu/stat462/sites/onlinecourses.science.psu.edu.stat462/files/data/poverty/index.txt"</span></span>
<span id="cb2-3">emb_pob <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">read_delim</span>(url)</span></code></pre></div>
</div>
<p>Las variables <code>Brth15to17</code> y <code>Brth18to19</code> son las tasas brutas de natalidad por cada 1000 mujeres (en el a√±o 2002) en adolescentes de 15 a 17 a√±os y de 18 a 19 respectivamente. La variable <code>PovPct</code> representa la proporci√≥n (%) de la poblaci√≥n que vive bajo la l√≠nea de pobreza en cada una de las entidades de EEUU (<code>Location</code>). Las variables <code>ViolCrime</code> y <code>TeenBrth</code> no se explican por lo que no las usaremos.</p>
</section>
</section>
<section id="regresiones-lineales" class="level1">
<h1>Regresiones lineales</h1>
<p>Usaremos <code>Brth15to17</code> y <code>PovPct</code> para estudiar si hay una relaci√≥n entre la tasa de natalidad en adolescentes y el porcentaje de la poblaci√≥n en pobreza. Para ello comenzaremos con graficar:</p>
<div class="cell">
<details>
<summary>C√≥digo</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">ggplot</span>(emb_pob) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">y =</span> Brth15to17), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#bc5090"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">3</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb3-4">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Porcentaje en pobreza"</span>,</span>
<span id="cb3-5">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Tasa bruta de natalidad (por cada 1,000 mujeres adolescentes)"</span>,</span>
<span id="cb3-6">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Relaci√≥n entre tasa bruta de natalidad en adolescentes</span><span class="sc" style="color: #5E5E5E;">\n</span><span class="st" style="color: #20794D;">de 15 a 19 a√±os y porcentaje en pobreza"</span></span>
<span id="cb3-7">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;">theme_bw</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Parece que a mayor porcentaje de pobreza, mayor tasa bruta de natalidad en adolescentes.</p>
<section id="planteamiento-cl√°sico" class="level2">
<h2 class="anchored" data-anchor-id="planteamiento-cl√°sico">Planteamiento cl√°sico</h2>
<p>Si la relaci√≥n fuera perfecta todos los casos caer√≠an <em>exactamente</em> en una l√≠nea recta como sigue:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>donde es necesario especificar dos par√°metros: el intercepto (el valor que toma cuando la <img src="https://latex.codecogs.com/png.latex?x"> en este caso <code>PovPct</code> vale cero) y la pendiente (el valor que relaciona por cada unidad de aumento en <code>PovPct</code> cu√°nto aumenta <code>Brth15to17</code>).</p>
<p>La ecuaci√≥n de la l√≠nea est√° dada por:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ay%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20x%0A"></p>
<p>donde <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0"> es el intercepto y <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> la pendiente. Usando la terminolog√≠a de arriba:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20=%20%5Ctext%7BIntercepto%7D%20+%20%5Ctext%7BPendiente%7D%5Ctimes%20%5Ctext%7BPovPct%7D%0A"> en particular en ese ejemplo:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20=%205%20+%203%5Ccdot%20%5Ctext%7BPovPct%7D%0A"></p>
<p>La idea es que el intercepto (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_0"> √≥ <img src="https://latex.codecogs.com/png.latex?5">) te indica d√≥nde comienza tu l√≠nea cuando no tienes <img src="https://latex.codecogs.com/png.latex?x">‚Äôs (es decir cuando <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BPovPct%7D%20=%200">). El intercepto controla la altura de la l√≠nea como puedes ver en la siguiente gr√°fica donde puse varios interceptos distintos:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>por otro lado la idea de la pendiente (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> √≥ <img src="https://latex.codecogs.com/png.latex?3">) es retratar c√≥mo cambia la <img src="https://latex.codecogs.com/png.latex?y"> (en este caso <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BBrth15to17%7D">) por cada unidad que cambia la <img src="https://latex.codecogs.com/png.latex?x"> (en este caso <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BPovPct%7D">). El valor de <img src="https://latex.codecogs.com/png.latex?3"> por ejemplo indica que por cada aumento en 1 en <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BPovPct%7D"> la variable <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BBrth15to17%7D"> aumenta en <img src="https://latex.codecogs.com/png.latex?3">. Este cambio es proporcional; es decir si ahora <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BPovPct%7D"> aumenta 4 (por decir algo) <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BBrth15to17%7D"> aumenta <img src="https://latex.codecogs.com/png.latex?3%5Ctimes%204%20=%2012"> unidades. La siguiente gr√°fica muestra varias l√≠neas todas comenzando en el mismo intercepto de <img src="https://latex.codecogs.com/png.latex?5">:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Como ya vimos en la primer figura el mundo no es tan perfecto que todo sea una l√≠nea recta. Hay un poco de aleatoriedad involucrada (sea por variables no medidas, por errores de medici√≥n o porque el mundo no sea determinista). Por lo cual se plantea que en lugar de que la <img src="https://latex.codecogs.com/png.latex?y"> sea <em>exactamente</em> <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0%20+%20%5Cbeta_1%20x"> planteamos que la <img src="https://latex.codecogs.com/png.latex?y"> proviene de una variable aleatoria normal donde la media de esa normal <strong>es</strong> <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0%20+%20%5Cbeta_1%20x">; es decir:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ay%20%5Csim%20%5Ctextrm%7BNormal%7D(%20%5Cbeta_0%20+%20%5Cbeta_1%20x,%20%5Csigma%5E2)%0A"></p>
<p>o dicho de otra manera:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BNormal%7D(%5Ctext%7BIntercepto%7D%20+%20%5Ctext%7BPendiente%7D%5Ctimes%20%5Ctext%7BPovPct%7D,%20%5Csigma%5E2)%0A"></p>
<p>donde la <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> es la varianza de dicha normal. Puesto gr√°ficamente lo que esto quiere decir es que si, por ejemplo, el intercepto es <img src="https://latex.codecogs.com/png.latex?5"> y la pendiente <img src="https://latex.codecogs.com/png.latex?3"> entonces cada medici√≥n de <img src="https://latex.codecogs.com/png.latex?y"> viene de una normal ligeramente distinta:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BNormal%7D(5%20+%203%5Ctimes%20%5Ctext%7BPovPct%7D,%20%5Csigma%5E2)%0A"></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Dicho de otra forma, suponemos que en un mundo perfecto los valores de <img src="https://latex.codecogs.com/png.latex?y"> (<code>Brth15to17</code>) estar√≠an completamente determinados por los de <img src="https://latex.codecogs.com/png.latex?x"> (<code>PovPct</code>) mediante la ecuaci√≥n de la recta. <strong>Pero</strong> como el mundo no es perfecto entonces la <img src="https://latex.codecogs.com/png.latex?y"> proviene de una normal con promedio dado por la recta. Los puntos (como puedes ver an la siguiente gr√°fica) se centran m√°s en torno a los promedios de las normales sin embargo est√°n colocados aleatoriamente pues corresponden a distintas realizaciones de <img src="https://latex.codecogs.com/png.latex?y">.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Por ejemplo si el porcentaje de pobreza (<code>PovPct</code>) es <img src="https://latex.codecogs.com/png.latex?10"> entonces la normal de la que provienen estos datos es:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BNormal%7D(%5Cunderbrace%7B5%20+%203%5Ctimes%2010%7D_%7B35%7D,%20%5Csigma%5E2)%0A"></p>
<p>mientras que si el porcentaje en pobreza es <img src="https://latex.codecogs.com/png.latex?20"> entonces la normal es:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BNormal%7D(%5Cunderbrace%7B5%20+%203%5Ctimes%2020%7D_%7B65%7D,%20%5Csigma%5E2)%0A"></p>
<p>Por supuesto que no hay nada de especial con el modelo normal y alguien podr√≠a elegir otra distribuci√≥n (por ejemplo una Gamma) y establecer que:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BGamma%7D(%5Ctext%7BIntercepto%7D%20+%20%5Ctext%7BPendiente%7D%5Ctimes%20%5Ctext%7BPovPct%7D,%20%5Cbeta)%0A"></p>
<p>Estos modelos son algunos de los lineales generalizados y los discutiremos m√°s adelante. Por ahora nos quedaremos con la idea del modelo dado por:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BNormal%7D(%5Ctext%7BIntercepto%7D%20+%20%5Ctext%7BPendiente%7D%5Ctimes%20%5Ctext%7BPovPct%7D,%20%5Csigma%5E2)%0A"></p>
<blockquote class="blockquote">
<p><strong>Nota</strong> quiz√° conoces la regresi√≥n lineal bajo la idea cl√°sica de que <img src="https://latex.codecogs.com/png.latex?%0Ay%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20x%20+%20%5Cepsilon%0A"> donde <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%5Csim%5Ctext%7BNormal%7D(0,%5Csigma%5E2)"> son los errores normales. Esta definici√≥n es equivalente a la que damos aqu√≠ pues por <a href="https://en.wikipedia.org/wiki/Normal_distribution#Properties">propiedades aditivas de la normal</a> <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%20+%20%5Cbeta_0%20+%20%5Cbeta_1%20x"> se sigue distribuyendo normal pero con la media ahora dada por lo agregado (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_0%20+%20%5Cbeta_1%20x">). Las ventajas de esta notaci√≥n es que un modelo para regresi√≥n Poisson es simplemente: <img src="https://latex.codecogs.com/png.latex?%0Ay%20%5Csim%20%5Ctextrm%7BPoisson%7D%5Cbig(%5Cexp(%5Cbeta_0%20+%20%5Cbeta_1%20x)%5Cbig)%0A"> y un modelo para regresi√≥n log√≠stica es: <img src="https://latex.codecogs.com/png.latex?%0Ay%20%5Csim%20%5Ctextrm%7BBernoulli%7D%5Cbig(%5Ctextrm%7Blogit%7D(%5Cbeta_0%20+%20%5Cbeta_1%20x)%5Cbig)%0A"></p>
</blockquote>
</section>
<section id="planteamiento-en-r" class="level2">
<h2 class="anchored" data-anchor-id="planteamiento-en-r">Planteamiento en <code>R</code></h2>
<p>Lo que nos toca ahora es programar nuestro modelo para ello seguiremos la filosof√≠a de tidymodels que pretende unificar bajo la misma notaci√≥n todos los modelos. La notaci√≥n b√°sica es como sigue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;">set_engine</span>(<span class="st" style="color: #20794D;">"tipo de ajuste"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;">fit</span>(<span class="st" style="color: #20794D;">"formula a ajustar"</span>, <span class="at" style="color: #657422;">data =</span> tus_datos)</span></code></pre></div>
</div>
<p>A partir del ajuste se pueden predecir cosas con <code>predict</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;">set_engine</span>(<span class="st" style="color: #20794D;">"tipo de ajuste"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;">fit</span>(<span class="st" style="color: #20794D;">"formula a ajustar"</span>, <span class="at" style="color: #657422;">data =</span> tus_datos) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;">predict</span>()</span></code></pre></div>
</div>
<p>o extraer nuevos datos con <code>extract_fit_engine</code> y <code>tidy</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;">set_engine</span>(<span class="st" style="color: #20794D;">"tipo de ajuste"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;">fit</span>(<span class="st" style="color: #20794D;">"formula a ajustar"</span>, <span class="at" style="color: #657422;">data =</span> tus_datos) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;">tidy</span>()</span></code></pre></div>
</div>
<p>Comencemos con nuestro primer modelo: una regresi√≥n lineal cl√°sica dada por:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BBrth15to17%7D%20%20%5Csim%20%5Ctextrm%7BNormal%7D(%5Ctext%7BIntercepto%7D%20+%20%5Ctext%7BPendiente%7D%5Ctimes%20%5Ctext%7BPovPct%7D,%20%5Csigma%5E2)%0A"></p>
<p>En <code>R</code> el <code>engine</code> que necesitamos es ‚Äúlm‚Äù que es el cl√°sico:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;">#Ajusta un modelo lineal </span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;">#Brth15to17 = intercepto + pendiente*PovPct</span></span>
<span id="cb7-3">modelo_ajustado <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">linear_reg</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;">set_engine</span>(<span class="st" style="color: #20794D;">"lm"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;">fit</span>(Brth15to17 <span class="sc" style="color: #5E5E5E;">~</span> PovPct, <span class="at" style="color: #657422;">data =</span> emb_pob) <span class="co" style="color: #5E5E5E;">#Notaci√≥n y ~ x</span></span></code></pre></div>
</div>
<p>Nota que a diferencia de <code>Stata</code>, <code>R</code> no arroja demasiados resultados. Podemos usar <code>extract_fit_engine</code> combinado con <code>summary</code> para obtenerlos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;">#Ajusta un modelo lineal </span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;">#Brth15to17 = intercepto + pendiente*PovPct</span></span>
<span id="cb8-3">modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;">summary</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
stats::lm(formula = Brth15to17 ~ PovPct, data = data)

Residuals:
     Min       1Q   Median       3Q      Max 
-11.2275  -3.6554  -0.0407   2.4972  10.5152 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   4.2673     2.5297   1.687    0.098 .  
PovPct        1.3733     0.1835   7.483 1.19e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.551 on 49 degrees of freedom
Multiple R-squared:  0.5333,    Adjusted R-squared:  0.5238 
F-statistic:    56 on 1 and 49 DF,  p-value: 1.188e-09</code></pre>
</div>
</div>
<p>o bien con <code>tidy</code> si deseamos nos devuelva una tabla de resultados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;">#Ajusta un modelo lineal </span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;">#Brth15to17 = intercepto + pendiente*PovPct</span></span>
<span id="cb10-3">modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;">tidy</span>() </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 √ó 5
  term        estimate std.error statistic       p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
1 (Intercept)     4.27     2.53       1.69 0.0980       
2 PovPct          1.37     0.184      7.48 0.00000000119</code></pre>
</div>
</div>
<p>Seg√∫n el tipo de regresi√≥n que estemos haciendo es el tipo de tabla que regresa <code>tidy</code> (ver <code>?tidy</code>). En particular, por ejemplo, podemos modificar para que devuelva intervalos de confianza al 90%:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;">#Ajusta un modelo lineal </span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;">#Brth15to17 = intercepto + pendiente*PovPct</span></span>
<span id="cb12-3">modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;">tidy</span>(<span class="at" style="color: #657422;">conf.int =</span> T, <span class="at" style="color: #657422;">conf.level =</span> <span class="fl" style="color: #AD0000;">0.90</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 √ó 7
  term        estimate std.error statistic       p.value conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)     4.27     2.53       1.69 0.0980          0.0260      8.51
2 PovPct          1.37     0.184      7.48 0.00000000119   1.07        1.68</code></pre>
</div>
</div>
<p>En este caso, el modelo estima que el intercepto (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) es <img src="https://latex.codecogs.com/png.latex?4.27"> y la pendiente (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_1">) es <img src="https://latex.codecogs.com/png.latex?1.37">. Como son <em>estimadores</em> del verdadero valor se denotan con <em>gorrito</em>: <img src="https://latex.codecogs.com/png.latex?%5Chat%5Cbeta_0%20=%204.27"> y <img src="https://latex.codecogs.com/png.latex?%5Chat%5Cbeta_1%20=%201.37">.</p>
<p>Podemos utilizar la funci√≥n de <code>predict</code> para que el modelo nos muestre c√≥mo cree que son los verdaderos valores en relaci√≥n a los ajustados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;">#Ajusta un modelo lineal </span></span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;">#Brth15to17 = intercepto + pendiente*PovPct</span></span>
<span id="cb14-3">predichos <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;">predict</span>(<span class="at" style="color: #657422;">new_data =</span> emb_pob)</span>
<span id="cb14-5"></span>
<span id="cb14-6">intervalo_predichos <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;">predict</span>(<span class="at" style="color: #657422;">new_data =</span> emb_pob, <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"pred_int"</span>, <span class="at" style="color: #657422;">level =</span> <span class="fl" style="color: #AD0000;">0.95</span>)</span>
<span id="cb14-8"></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;">#Juntamos los predichos con los observados</span></span>
<span id="cb14-10">obs_y_modelo <span class="ot" style="color: #003B4F;">&lt;-</span> emb_pob <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb14-11">  <span class="fu" style="color: #4758AB;">cbind</span>(predichos) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb14-12">  <span class="fu" style="color: #4758AB;">cbind</span>(intervalo_predichos)</span>
<span id="cb14-13"></span>
<span id="cb14-14"><span class="co" style="color: #5E5E5E;">#Graficamos</span></span>
<span id="cb14-15"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-16">  <span class="fu" style="color: #4758AB;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">ymin =</span> .pred_lower, <span class="at" style="color: #657422;">ymax =</span> .pred_upper), </span>
<span id="cb14-17">              <span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"#003f5c"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">alpha =</span> <span class="fl" style="color: #AD0000;">0.5</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-18">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">y =</span> Brth15to17), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#bc5090"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">3</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-19">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">y =</span> .pred), </span>
<span id="cb14-20">            <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#003f5c"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-21">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb14-22">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Porcentaje en pobreza"</span>,</span>
<span id="cb14-23">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Tasa bruta de natalidad (por cada 1,000 mujeres adolescentes)"</span>,</span>
<span id="cb14-24">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Relaci√≥n entre tasa bruta de natalidad en adolescentes</span><span class="sc" style="color: #5E5E5E;">\n</span><span class="st" style="color: #20794D;">de 15 a 19 a√±os y porcentaje en pobreza"</span></span>
<span id="cb14-25">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-26">  <span class="fu" style="color: #4758AB;">theme_bw</span>()</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Nada m√°s a ojo no parece que el modelo sea el mejor pues puedes ver que no explica bien la variabilidad (los observados var√≠an mucho respecto al intervalo). La <img src="https://latex.codecogs.com/png.latex?R%5E2">, una m√©trica que explica cu√°nto de la varianza captura el modelo tampoco es muy buena:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">resumen_ajuste <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;">summary</span>()</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;">#R^2 cl√°sica</span></span>
<span id="cb15-6">resumen_ajuste<span class="sc" style="color: #5E5E5E;">$</span>r.squared</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.533328</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;">#R^2 ajustada</span></span>
<span id="cb17-2">resumen_ajuste<span class="sc" style="color: #5E5E5E;">$</span>adj.r.squared</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.523804</code></pre>
</div>
</div>
<p>Podemos checar las diferentes gr√°ficas de diagn√≥stico:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;">library</span>(ggfortify)</span>
<span id="cb19-2"><span class="fu" style="color: #4758AB;">autoplot</span>(modelo_ajustado, <span class="at" style="color: #657422;">which =</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">5</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Veamos qu√© significa cada una de ellas y juguemos un poco con <code>R</code> para irlas modificando.</p>
<section id="residuales-contra-ajustados" class="level3">
<h3 class="anchored" data-anchor-id="residuales-contra-ajustados">Residuales contra ajustados</h3>
<p>Los <strong>residuales</strong> son la diferencia entre el modelo (<img src="https://latex.codecogs.com/png.latex?%5Chat%7By%7D">) y lo real <img src="https://latex.codecogs.com/png.latex?y">. En el caso que est√°bamos trabajando tenemos que con nuestro modelo podemos predecir los valores de <code>Brth15to17</code> a partir del porcentaje en pobreza <code>PovPct</code>. A los valores predichos por el modelo de <code>Brth15to17</code> les ponemos un gorro encima y los llamamos: <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Ctext%7BBrth15to17%7D%7D">. Estos est√°n dados por la siguiente funci√≥n:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Ctext%7BBrth15to17%7D%7D%20=%204.26%20+%201.37%20%5Ccdot%20%5Ctext%7BPovPct%7D%0A"></p>
<p>por ejemplo para el porcentaje en pobreza de <img src="https://latex.codecogs.com/png.latex?20.1"> obtendr√≠amos:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Ctext%7BBrth15to17%7D%7D%20=%204.26%20+%201.37%20%5Ccdot%20%5Ctext%7BPovPct%7D%20=%2031.797%0A"></p>
<p>por otro lado el verdadero valor de cuando el <code>PovPct</code> es <img src="https://latex.codecogs.com/png.latex?20.1"> (estado de <code>Alabama</code>) es <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BBrth15to17%7D%20=%2031.5">. La diferencia entre el verdadero valor (<img src="https://latex.codecogs.com/png.latex?%5Ctext%7BBrth15to17%7D%20=%2031.5">) y el predicho por el modelo (<img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Ctext%7BBrth15to17%7D%7D%20=%2031.797">) se conoce como el residual. La idea es que en un modelo bueno no debe haber patrones en los residuales (todos deben de flotar en torno al cero pero no mostrar un patr√≥n).</p>
<p>Veamoslo en nuestra base:</p>
<div class="cell">
<details>
<summary>C√≥digo</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">obs_y_modelo <span class="ot" style="color: #003B4F;">&lt;-</span> obs_y_modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb20-2">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">residuales =</span> Brth15to17 <span class="sc" style="color: #5E5E5E;">-</span> .pred)</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-5">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> .pred, <span class="at" style="color: #657422;">y =</span> residuales), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#ff6361"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-6">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb20-7">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Valores ajustados (predichos)"</span>,</span>
<span id="cb20-8">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Residuales"</span>,</span>
<span id="cb20-9">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Residuales vs ajustados"</span></span>
<span id="cb20-10">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-11">  <span class="fu" style="color: #4758AB;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-12">  <span class="fu" style="color: #4758AB;">geom_hline</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">yintercept =</span> <span class="dv" style="color: #AD0000;">0</span>), <span class="at" style="color: #657422;">linetype =</span> <span class="st" style="color: #20794D;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En esta gr√°fica el modelo predice mejor rumbo al final que en medio y esto parece estar corroborado por la gr√°fica del modelo (previa). Nada m√°s para darnos una idea veamos una gr√°fica de <em>malos</em> residuales y una de <em>buenos</em></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="escala-locaci√≥n" class="level3">
<h3 class="anchored" data-anchor-id="escala-locaci√≥n">Escala locaci√≥n</h3>
<p>Representa la escala locaci√≥n contra los residuales estandarizados. La idea de la gr√°fica es ver que la varianza <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> del modelo no cambie conforme cambia la <img src="https://latex.codecogs.com/png.latex?x"> (propiedad de <em>homoscedasticidad</em>). Para ello graficamos los residuales estandarizados dados por los residuales mismos dividos entre su desviaci√≥n est√°ndar:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ar_%7B%5Ctext%7BStd%7D%7D%20=%20%5Cfrac%7B%5Chat%7By%7D%20-%20y%7D%7B%5Ctext%7Bsd%7D(%5Chat%7By%7D%20-%20y)%7D%20=%20%5Cfrac%7B%5Ctext%7BResiduales%7D%7D%7B%5Ctext%7Bsd%7D%5Cbig(%5Ctext%7BResiduales%7D%5Cbig)%7D%0A"></p>
<p>estos residuales estandarizados los podemos calcular en <code>R</code> como sigue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">obs_y_modelo <span class="ot" style="color: #003B4F;">&lt;-</span> obs_y_modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb21-2">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">residuales_std =</span> residuales<span class="sc" style="color: #5E5E5E;">/</span><span class="fu" style="color: #4758AB;">sd</span>(residuales))</span></code></pre></div>
</div>
<p>Si los graficamos contra los valores ajustados no deber√≠amos de ver ning√∫n patr√≥n:</p>
<div class="cell">
<details>
<summary>C√≥digo</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb22-2">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> .pred, <span class="at" style="color: #657422;">y =</span> residuales_std), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#ff6361"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb22-3">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb22-4">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Valores ajustados (predichos)"</span>,</span>
<span id="cb22-5">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Residuales estandarizados"</span>,</span>
<span id="cb22-6">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Escala Locaci√≥n"</span></span>
<span id="cb22-7">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb22-8">  <span class="fu" style="color: #4758AB;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb22-9">  <span class="fu" style="color: #4758AB;">geom_hline</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">yintercept =</span> <span class="dv" style="color: #AD0000;">0</span>), <span class="at" style="color: #657422;">linetype =</span> <span class="st" style="color: #20794D;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos ver c√≥mo se ven estos puntos en el modelo ideal vs en un modelo donde la <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> depende de la <img src="https://latex.codecogs.com/png.latex?x">:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="normal-cuantil-cuantil" class="level3">
<h3 class="anchored" data-anchor-id="normal-cuantil-cuantil">Normal cuantil cuantil</h3>
<p>La segunda gr√°fica corresponde a una gr√°fica cuantil cuantil. Esta la utilizamos para verificar la hip√≥tesis de normalidad. En una gr√°fica cuantil cuantil se grafican los cuantiles de los residuales contra los cuantiles te√≥ricos de la normal. Por ejemplo si la hacemos con s√≥lo 4 puntos se ver√≠a algo as√≠:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos armar una gr√°fica cuantil cuantil con <code>ggplot2</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">sample =</span> residuales)) <span class="sc" style="color: #5E5E5E;">+</span> </span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;">stat_qq</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#ff6361"</span>) <span class="sc" style="color: #5E5E5E;">+</span> </span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;">stat_qq_line</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#58508d"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb23-5">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb23-6">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Cuantiles te√≥ricos de la normal"</span>,</span>
<span id="cb23-7">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Cuantiles observados de los residuales"</span>,</span>
<span id="cb23-8">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Gr√°fica qq"</span></span>
<span id="cb23-9">  )</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>La idea de la gr√°fica cuantil cuantil es que los puntos sigan la l√≠nea lo m√°s posible. Veamos c√≥mo se ve con los datos bien (y los mal)</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="residuales-contra-apalancamiento" class="level3">
<h3 class="anchored" data-anchor-id="residuales-contra-apalancamiento">Residuales contra apalancamiento</h3>
<p>El apalancamiento representa qu√© tanto cambia el modelo al quitar una sola observaci√≥n. Para poner un ejemplo considera los siguientes datos donde hay un valor at√≠pico y selecciono dos puntos de inter√©s en dos colores:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Veamos c√≥mo cambia la regresi√≥n si dejo todos los puntos, si quito el normal y si quito el influyente:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Nota que el modelo no cambia pr√°cticamente nada cuando hago la regresi√≥n sin el dato que marqu√© como <code>normal</code> pero cambia mucho cuando quito el que marqu√© como <code>influyente</code>. La gr√°fica de residuales contra apalancamiento muestra tambi√©n el valor extra√±o:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>El apalancamiento mide la influencia de un dato y en <code>R</code> se puede calcular con <code>hatvalues</code>. Los datos con mayor <strong>apalancamiento</strong> siempre valen la pena checarlos para verificar que todo opera en orden.</p>
<div class="cell">
<details>
<summary>C√≥digo</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">apalancamiento <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb24-3">  <span class="fu" style="color: #4758AB;">hatvalues</span>()</span>
<span id="cb24-4"></span>
<span id="cb24-5">obs_y_modelo <span class="ot" style="color: #003B4F;">&lt;-</span> obs_y_modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb24-6">  <span class="fu" style="color: #4758AB;">cbind</span>(apalancamiento)</span>
<span id="cb24-7"></span>
<span id="cb24-8"><span class="co" style="color: #5E5E5E;">#Graficamos residuales contra apalancamiento</span></span>
<span id="cb24-9"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb24-10">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> apalancamiento, <span class="at" style="color: #657422;">y =</span> residuales), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#ff6361"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb24-11">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb24-12">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Apalancamiento"</span>,</span>
<span id="cb24-13">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Residuales"</span>,</span>
<span id="cb24-14">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Residuales vs ajustados"</span></span>
<span id="cb24-15">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb24-16">  <span class="fu" style="color: #4758AB;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb24-17">  <span class="fu" style="color: #4758AB;">geom_hline</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">yintercept =</span> <span class="dv" style="color: #AD0000;">0</span>), <span class="at" style="color: #657422;">linetype =</span> <span class="st" style="color: #20794D;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="distancia-de-cook" class="level3">
<h3 class="anchored" data-anchor-id="distancia-de-cook">Distancia de Cook</h3>
<p>La distancia de Cook es un concepto similar al apalancamiento que identifica observaciones influyentes. Aquellos valores con distancia de Cook alta vale la pena revisar. En <code>R</code> podemos usar <code>cooks.distance</code> para calcular la distancia de Cook.</p>
<div class="cell">
<details>
<summary>C√≥digo</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">distanciaCook <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_ajustado <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb25-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;">cooks.distance</span>()</span>
<span id="cb25-4"></span>
<span id="cb25-5">obs_y_modelo <span class="ot" style="color: #003B4F;">&lt;-</span> obs_y_modelo <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb25-6">  <span class="fu" style="color: #4758AB;">cbind</span>(distanciaCook)</span>
<span id="cb25-7"></span>
<span id="cb25-8"><span class="co" style="color: #5E5E5E;">#Graficamos residuales contra apalancamiento</span></span>
<span id="cb25-9"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb25-10">  <span class="fu" style="color: #4758AB;">geom_col</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="fu" style="color: #4758AB;">nrow</span>(obs_y_modelo), <span class="at" style="color: #657422;">y =</span> distanciaCook), <span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"#ff6361"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb25-11">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb25-12">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Observaci√≥n (n√∫mero de entrada en la base)"</span>,</span>
<span id="cb25-13">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Distancia de Cook"</span>,</span>
<span id="cb25-14">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Distancia de Cook"</span></span>
<span id="cb25-15">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb25-16">  <span class="fu" style="color: #4758AB;">theme_bw</span>() </span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>podemos ver que en el ejemplo anterior (el de la observaci√≥n influyente) la distancia de Cook es exagerada, tan exagerada que ni se alcanzan a ver los otros:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="ejercicios" class="level2">
<h2 class="anchored" data-anchor-id="ejercicios">Ejercicios</h2>
<ol type="1">
<li>Corre el siguiente c√≥digo para generar una base de datos de nombre <code>datLong</code> que contiene <img src="https://latex.codecogs.com/png.latex?4"> grupos. Para cada grupo genere una regresi√≥n lineal de la forma:</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0Ay%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20x%0A"></p>
<p>Identifica cu√°les regresiones s√≠ ajustan bien y cu√°les no mediante los gr√°ficos de diagn√≥stico. Finalmente grafica tus datos <img src="https://latex.codecogs.com/png.latex?x"> contra <img src="https://latex.codecogs.com/png.latex?y"> y la regresi√≥n para ver que lo hayas hecho bien. ¬øHay alguna forma de corregir alguna de las que no ajusta bien?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">dat <span class="ot" style="color: #003B4F;">&lt;-</span> datasets<span class="sc" style="color: #5E5E5E;">::</span>anscombe</span>
<span id="cb26-2">datLong <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(</span>
<span id="cb26-3">    <span class="at" style="color: #657422;">grupo  =</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">4</span>, <span class="at" style="color: #657422;">each =</span> <span class="dv" style="color: #AD0000;">11</span>),</span>
<span id="cb26-4">    <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">unlist</span>(dat[,<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">4</span>)]),</span>
<span id="cb26-5">    <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">unlist</span>(dat[,<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">5</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">8</span>)])</span>
<span id="cb26-6">    )</span>
<span id="cb26-7"><span class="fu" style="color: #4758AB;">rownames</span>(datLong) <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cn" style="color: #8f5902;">NULL</span></span></code></pre></div>
</div>
<ol start="2" type="1">
<li><p>Lee la base de datos de <img src="https://latex.codecogs.com/png.latex?n%20=%20345"> ni√±os entre <img src="https://latex.codecogs.com/png.latex?6"> y <img src="https://latex.codecogs.com/png.latex?10"> a√±os de <a href="https://online.stat.psu.edu/stat462/sites/onlinecourses.science.psu.edu.stat462/files/data/fev_dat/index.txt">Kahn, Michael (2005)</a>. Las variables de inter√©s son <img src="https://latex.codecogs.com/png.latex?y%20=%20%5Ctext%7BFEV%7D"> el volumen de expiraci√≥n forzada y <img src="https://latex.codecogs.com/png.latex?x%20=%20%5Ctext%7Bedad%7D"> en a√±os. Realiza una regresi√≥n lineal. Justifica que no se cumple la homocedasticidad mediante una gr√°fica de escala locaci√≥n.</p></li>
<li><p>Plantee una regresi√≥n lineal usando <a href="https://data.princeton.edu/wws509/datasets/#salary">los datos de esta liga</a> para determinar si el sexo influye en el salario. <strong>Ojo</strong> en la regresi√≥n es necesario incluir otras covariables.</p></li>
</ol>
</section>
<section id="y-si-lo-hacemos-bayesiano" class="level2">
<h2 class="anchored" data-anchor-id="y-si-lo-hacemos-bayesiano">¬øY si lo hacemos bayesiano?</h2>
<p>Para hacer la misma regresi√≥n lineal pero con estad√≠stica bayesiana podemos nada m√°s cambiar el <code>engine</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="co" style="color: #5E5E5E;">#Ajusta un modelo lineal </span></span>
<span id="cb27-2"><span class="co" style="color: #5E5E5E;">#Brth15to17 = intercepto + pendiente*PovPct</span></span>
<span id="cb27-3">modelo_bayesiano <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">linear_reg</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb27-4">  <span class="fu" style="color: #4758AB;">set_engine</span>(<span class="st" style="color: #20794D;">"stan"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb27-5">  <span class="fu" style="color: #4758AB;">fit</span>(Brth15to17 <span class="sc" style="color: #5E5E5E;">~</span> PovPct, <span class="at" style="color: #657422;">data =</span> emb_pob) <span class="co" style="color: #5E5E5E;">#Notaci√≥n y ~ x</span></span></code></pre></div>
</div>
<p>Y podemos ver el ajuste:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">modelo_bayesiano <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb28-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;">summary</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Model Info:
 function:     stan_glm
 family:       gaussian [identity]
 formula:      Brth15to17 ~ PovPct
 algorithm:    sampling
 sample:       4000 (posterior sample size)
 priors:       see help('prior_summary')
 observations: 51
 predictors:   2

Estimates:
              mean   sd   10%   50%   90%
(Intercept) 4.3    2.6  0.9   4.3   7.7  
PovPct      1.4    0.2  1.1   1.4   1.6  
sigma       5.7    0.6  4.9   5.6   6.4  

Fit Diagnostics:
           mean   sd   10%   50%   90%
mean_PPD 22.3    1.1 20.9  22.3  23.7 

The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help('summary.stanreg')).

MCMC diagnostics
              mcse Rhat n_eff
(Intercept)   0.0  1.0  4252 
PovPct        0.0  1.0  4286 
sigma         0.0  1.0  3968 
mean_PPD      0.0  1.0  4057 
log-posterior 0.0  1.0  1705 

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
</div>
</div>
<p>o realizar predicciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">predichos <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_bayesiano <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb30-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb30-3">  <span class="fu" style="color: #4758AB;">predict</span>(<span class="at" style="color: #657422;">new_data =</span> emb_pob)</span>
<span id="cb30-4"></span>
<span id="cb30-5">ic <span class="ot" style="color: #003B4F;">&lt;-</span> modelo_bayesiano <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb30-6">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb30-7">  <span class="fu" style="color: #4758AB;">predictive_interval</span>(<span class="at" style="color: #657422;">newdata =</span> emb_pob, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.95</span>) <span class="co" style="color: #5E5E5E;">#Para bayesiana</span></span>
<span id="cb30-8"></span>
<span id="cb30-9"><span class="co" style="color: #5E5E5E;">#Juntamos los predichos con los observados</span></span>
<span id="cb30-10">obs_y_modelo <span class="ot" style="color: #003B4F;">&lt;-</span> emb_pob <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb30-11">  <span class="fu" style="color: #4758AB;">cbind</span>(predichos) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb30-12">  <span class="fu" style="color: #4758AB;">cbind</span>(ic)</span>
<span id="cb30-13"></span>
<span id="cb30-14"><span class="co" style="color: #5E5E5E;">#Graficamos</span></span>
<span id="cb30-15"><span class="fu" style="color: #4758AB;">ggplot</span>(obs_y_modelo) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb30-16">  <span class="fu" style="color: #4758AB;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">ymin =</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">2.5%</span><span class="st" style="color: #20794D;">`</span>, <span class="at" style="color: #657422;">ymax =</span> <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">97.5%</span><span class="st" style="color: #20794D;">`</span>), </span>
<span id="cb30-17">              <span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"#003f5c"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">alpha =</span> <span class="fl" style="color: #AD0000;">0.5</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb30-18">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">y =</span> Brth15to17), <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#ffa600"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">3</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb30-19">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> PovPct, <span class="at" style="color: #657422;">y =</span> predichos), </span>
<span id="cb30-20">            <span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"#003f5c"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb30-21">  <span class="fu" style="color: #4758AB;">labs</span>(</span>
<span id="cb30-22">    <span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Porcentaje en pobreza"</span>,</span>
<span id="cb30-23">    <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Tasa bruta de natalidad (por cada 1,000 mujeres adolescentes)"</span>,</span>
<span id="cb30-24">    <span class="at" style="color: #657422;">title =</span> <span class="st" style="color: #20794D;">"Relaci√≥n entre tasa bruta de natalidad en adolescentes</span><span class="sc" style="color: #5E5E5E;">\n</span><span class="st" style="color: #20794D;">de 15 a 19 a√±os y porcentaje en pobreza"</span></span>
<span id="cb30-25">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb30-26">  <span class="fu" style="color: #4758AB;">theme_bw</span>()</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Para validaci√≥n del modelo puedes checar <a href="https://mc-stan.org/rstanarm/articles/rstanarm.html#step-3-criticize-the-model-1">esta p√°gina</a> que explica <code>loo</code> (<a href="https://arxiv.org/abs/1507.04544">ver paper</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">modelo_bayesiano <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;">loo</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 51 log-likelihood matrix

         Estimate  SE
elpd_loo   -161.6 4.2
p_loo         2.4 0.5
looic       323.3 8.4
------
Monte Carlo SE of elpd_loo is 0.0.

All Pareto k estimates are good (k &lt; 0.5).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>asi como su visualizaci√≥n (si el modelo no fuera bueno)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">modelo_bayesiano <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb33-2">  <span class="fu" style="color: #4758AB;">extract_fit_engine</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;">loo</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;">plot</span>(<span class="at" style="color: #657422;">label_points =</span> <span class="cn" style="color: #8f5902;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="ejercicio" class="level2">
<h2 class="anchored" data-anchor-id="ejercicio">Ejercicio</h2>
<ol type="1">
<li>Utilice las opciones de <code>engine</code> para cambiar el <code>prior_intercept</code> del intercepto a una <code>t</code> de Student y el <code>prior</code> de los coeficientes a una <code>Laplace</code>. ¬øCambia mucho el resultado?</li>
</ol>


</section>
</section>

 ]]></description>
  <category>regresiones / regression</category>
  <category>regresi√≥n lineal / linear regression</category>
  <category>R</category>
  <category>espa√±ol / Spanish</category>
  <category>diagn√≥stico de modelos / model diagnosis</category>
  <guid>https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/index.html</guid>
  <pubDate>Sun, 06 Nov 2022 04:00:00 GMT</pubDate>
  <media:content url="https://rodrigozepeda.github.io/Statisticats/posts/regresiones-1/quetelet.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
